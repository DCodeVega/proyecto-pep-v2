
proyecto-pep-v2/.gitignore:
# Entorno virtual
venv/
env/
ENV/

# Python
__pycache__/
*.py[cod]
*.so
.Python
*.egg-info/
*.egg
dist/
build/

# Base de datos
*.db
*.sqlite3
database/*.db

# Environment variables
.env
.env.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# Sistema
.DS_Store
Thumbs.db

proyecto-pep-v2/Procfile:
web: gunicorn "proyecto_pep.app:app"

proyecto-pep-v2/app.py:
from flask import Flask, render_template, request, redirect, url_for, flash
import os
import sqlite3
from config import Config

# Inicializar la aplicación Flask
app = Flask(__name__)
app.config.from_object(Config)

# Función para conectar a la base de datos
def get_db_connection():
    import os        #borrar si da errores, es por railway
    import tempfile    #borrar si da errores, es por railway

    db_path = os.path.join(tempfile.gettempdir(), 'proyectos.db')
    conn = sqlite3.connect(db_path)
    
    #conn = sqlite3.connect(':memory:') # para arrancar en Railway
    #conn = sqlite3.connect(app.config['DATABASE_PATH']) # para arrancar en local original esto y el de abajo
    conn.row_factory = sqlite3.Row  # Para obtener diccionarios en lugar de tuplas
    return conn


# Crear tablas de la base de datos si no existen
def init_db():
    conn = get_db_connection()
    
    # Tabla de proyectos (como tu PRIMERA FASE en Excel)
    conn.execute('''
CREATE TABLE IF NOT EXISTS proyectos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    tipo_actividad TEXT,
    tiene_inversion INTEGER DEFAULT 0,
    valor_inversion REAL DEFAULT 0,
    tasa_descuento REAL DEFAULT 0.001,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
''')
    
    # En la función init_db(), después de la tabla de proyectos, añade:
    conn.execute('''
    CREATE TABLE IF NOT EXISTS productos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    nombre TEXT NOT NULL,
    precio REAL NOT NULL,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla de costos por producto (cada costo asociado a un producto específico)
    conn.execute('''
        CREATE TABLE IF NOT EXISTS costos_productos (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        producto_id INTEGER,
        nombre TEXT NOT NULL,
        valor REAL NOT NULL,
        FOREIGN KEY (producto_id) REFERENCES productos (id)
    )
    ''')
    
    conn.execute('''
        CREATE TABLE IF NOT EXISTS costos_generales (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        nombre TEXT NOT NULL,
        valor REAL NOT NULL,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla de costos (como tu SEGUNDA FASE - Costos)
    # conn.execute('''
    # CREATE TABLE IF NOT EXISTS costos (
    #     id INTEGER PRIMARY KEY AUTOINCREMENT,
    #     proyecto_id INTEGER,
    #     nombre TEXT NOT NULL,
    #     valor REAL NOT NULL,
    #     FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    # )
    # ''')
    
    # Modificar la tabla de costos para que incluya producto_id
    
    
    # conn.execute('''
    # CREATE TABLE IF NOT EXISTS costos (
    #     id INTEGER PRIMARY KEY AUTOINCREMENT,
    #     proyecto_id INTEGER,
    #     producto_id INTEGER,
    #     nombre TEXT NOT NULL,
    #     valor REAL NOT NULL,
    #     FOREIGN KEY (proyecto_id) REFERENCES proyectos (id),
    #     FOREIGN KEY (producto_id) REFERENCES productos (id)
    # )
    # ''')
    
    # Tabla de gastos (como tu SEGUNDA FASE - Gastos)
    conn.execute('''
    CREATE TABLE IF NOT EXISTS gastos (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        nombre TEXT NOT NULL,
        valor REAL NOT NULL,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla de personal (como tu TERCERA FASE - Viabilidad Operativa)
    conn.execute('''
    CREATE TABLE IF NOT EXISTS personal (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        nombre TEXT NOT NULL,
        perfil TEXT,
        salario_mensual REAL NOT NULL,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla de materiales (como tu Equipo y maquinaria)
    conn.execute('''
    CREATE TABLE IF NOT EXISTS materiales (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        nombre TEXT NOT NULL,
        valor REAL NOT NULL,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla para ventas por día
    conn.execute('''
    CREATE TABLE IF NOT EXISTS ventas_dias (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        lunes INTEGER DEFAULT 0,
        martes INTEGER DEFAULT 0,
        miercoles INTEGER DEFAULT 0,
        jueves INTEGER DEFAULT 0,
        viernes INTEGER DEFAULT 0,
        sabado INTEGER DEFAULT 0,
        domingo INTEGER DEFAULT 0,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla para ventas por semana
    conn.execute('''
    CREATE TABLE IF NOT EXISTS ventas_semanas (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        semana1 INTEGER DEFAULT 0,
        semana2 INTEGER DEFAULT 0,
        semana3 INTEGER DEFAULT 0,
        semana4 INTEGER DEFAULT 0,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla para ventas por mes
    conn.execute('''
    CREATE TABLE IF NOT EXISTS ventas_meses (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        enero INTEGER DEFAULT 0,
        febrero INTEGER DEFAULT 0,
        marzo INTEGER DEFAULT 0,
        abril INTEGER DEFAULT 0,
        mayo INTEGER DEFAULT 0,
        junio INTEGER DEFAULT 0,
        julio INTEGER DEFAULT 0,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla para ventas por año
    conn.execute('''
    CREATE TABLE IF NOT EXISTS ventas_anos (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        proyecto_id INTEGER,
        año1 INTEGER DEFAULT 0,
        año2 INTEGER DEFAULT 0,
        año3 INTEGER DEFAULT 0,
        año4 INTEGER DEFAULT 0,
        año5 INTEGER DEFAULT 0,
        año6 INTEGER DEFAULT 0,
        año7 INTEGER DEFAULT 0,
        FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
    )
    ''')
    
    # Tabla para ingresos por día (igual que ventas_dias)
    conn.execute('''
CREATE TABLE IF NOT EXISTS ingresos_dias (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    lunes REAL DEFAULT 0,
    martes REAL DEFAULT 0,
    miercoles REAL DEFAULT 0,
    jueves REAL DEFAULT 0,
    viernes REAL DEFAULT 0,
    sabado REAL DEFAULT 0,
    domingo REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')

# Tabla para ingresos por semana (igual que ventas_semanas)
    conn.execute('''
CREATE TABLE IF NOT EXISTS ingresos_semanas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    semana1 REAL DEFAULT 0,
    semana2 REAL DEFAULT 0,
    semana3 REAL DEFAULT 0,
    semana4 REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')

# Tabla para ingresos por mes (igual que ventas_meses)
    conn.execute('''
CREATE TABLE IF NOT EXISTS ingresos_meses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    enero REAL DEFAULT 0,
    febrero REAL DEFAULT 0,
    marzo REAL DEFAULT 0,
    abril REAL DEFAULT 0,
    mayo REAL DEFAULT 0,
    junio REAL DEFAULT 0,
    julio REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')

# Tabla para ingresos por año (igual que ventas_anos)
    conn.execute('''
CREATE TABLE IF NOT EXISTS ingresos_anos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    año1 REAL DEFAULT 0,
    año2 REAL DEFAULT 0,
    año3 REAL DEFAULT 0,
    año4 REAL DEFAULT 0,
    año5 REAL DEFAULT 0,
    año6 REAL DEFAULT 0,
    año7 REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')
    # En init_db(), añade estas tablas:
    conn.execute('''
CREATE TABLE IF NOT EXISTS utilidad_dias (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    lunes REAL DEFAULT 0,
    martes REAL DEFAULT 0,
    miercoles REAL DEFAULT 0,
    jueves REAL DEFAULT 0,
    viernes REAL DEFAULT 0,
    sabado REAL DEFAULT 0,
    domingo REAL DEFAULT 0,
    total_semana REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')

    conn.execute('''
CREATE TABLE IF NOT EXISTS utilidad_semanas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    semana1 REAL DEFAULT 0,
    semana2 REAL DEFAULT 0,
    semana3 REAL DEFAULT 0,
    semana4 REAL DEFAULT 0,
    total_mes REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')

    conn.execute('''
CREATE TABLE IF NOT EXISTS utilidad_meses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    enero REAL DEFAULT 0,
    febrero REAL DEFAULT 0,
    marzo REAL DEFAULT 0,
    abril REAL DEFAULT 0,
    mayo REAL DEFAULT 0,
    junio REAL DEFAULT 0,
    julio REAL DEFAULT 0,
    total_periodo REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')

    conn.execute('''
CREATE TABLE IF NOT EXISTS utilidad_anos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    proyecto_id INTEGER,
    año1 REAL DEFAULT 0,
    año2 REAL DEFAULT 0,
    año3 REAL DEFAULT 0,
    año4 REAL DEFAULT 0,
    año5 REAL DEFAULT 0,
    año6 REAL DEFAULT 0,
    año7 REAL DEFAULT 0,
    total_7anos REAL DEFAULT 0,
    FOREIGN KEY (proyecto_id) REFERENCES proyectos (id)
)
''')
    
    conn.commit()
    conn.close()

# Llamar a init_db al iniciar la aplicación
with app.app_context():
    init_db()

# ==================== RUTAS PRINCIPALES ====================

@app.route('/')
def index():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    conn.close()
    
    return render_template('index.html', proyecto=proyecto)

@app.route('/proyecto/datos-iniciales', methods=['GET', 'POST'])
def datos_iniciales():
    conn = get_db_connection()
    
    if request.method == 'POST':
        nombre = request.form.get('nombre')
        tipo_actividad = request.form.get('tipo_actividad')
        tiene_inversion = 1 if request.form.get('tiene_inversion') == 'si' else 0
        valor_inversion = float(request.form.get('valor_inversion', 0))
        tasa_descuento = float(request.form.get('tasa_descuento', 0.001))
        
        proyecto_existente = conn.execute('SELECT * FROM proyectos').fetchone()
        
        if proyecto_existente:
            conn.execute('''
                UPDATE proyectos SET 
                nombre = ?, tipo_actividad = ?, tiene_inversion = ?, 
                valor_inversion = ?, tasa_descuento = ?
                WHERE id = ?
            ''', (nombre, tipo_actividad, tiene_inversion, valor_inversion, 
                  tasa_descuento, proyecto_existente['id']))
            flash('Proyecto actualizado correctamente', 'success')
        else:
            conn.execute('''
                INSERT INTO proyectos 
                (nombre, tipo_actividad, tiene_inversion, valor_inversion, 
                 tasa_descuento)
                VALUES (?, ?, ?, ?, ?)
            ''', (nombre, tipo_actividad, tiene_inversion, valor_inversion, 
                  tasa_descuento))
            flash('Proyecto creado correctamente', 'success')
        
        conn.commit()
    
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    # Obtener productos si hay proyecto
    productos = []
    total_productos = 0
    if proyecto:
        productos = conn.execute('SELECT * FROM productos WHERE proyecto_id = ? ORDER BY id', 
                               (proyecto['id'],)).fetchall()
        total_productos_result = conn.execute('SELECT SUM(precio) as total FROM productos WHERE proyecto_id = ?', 
                                            (proyecto['id'],)).fetchone()
        total_productos = total_productos_result['total'] or 0 if total_productos_result else 0
    
    conn.close()
    
    return render_template('proyecto/datos_iniciales.html', 
                         proyecto=proyecto,
                         productos=productos,
                         total_productos=total_productos)

# ==================== FUNCIONES PARA PRODUCTOS ====================

@app.route('/proyecto/agregar-producto', methods=['POST'])
def agregar_producto():
    if request.method == 'POST':
        nombre = request.form.get('nombre_producto')
        precio = float(request.form.get('precio_producto', 0))
        
        conn = get_db_connection()
        proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
        
        if proyecto:
            conn.execute('INSERT INTO productos (proyecto_id, nombre, precio) VALUES (?, ?, ?)',
                        (proyecto['id'], nombre, precio))
            conn.commit()
            flash(f'Producto "{nombre}" agregado correctamente', 'success')
        else:
            flash('Primero debes crear un proyecto', 'warning')
        
        conn.close()
    
    return redirect(url_for('datos_iniciales'))

@app.route('/proyecto/editar-producto/<int:id>', methods=['POST'])
def editar_producto(id):
    if request.method == 'POST':
        nombre = request.form.get('nombre_producto')
        precio = float(request.form.get('precio_producto', 0))
        
        conn = get_db_connection()
        conn.execute('UPDATE productos SET nombre = ?, precio = ? WHERE id = ?',
                    (nombre, precio, id))
        conn.commit()
        conn.close()
        
        flash(f'Producto actualizado correctamente', 'success')
    
    return redirect(url_for('datos_iniciales'))

@app.route('/proyecto/eliminar-producto/<int:id>')
def eliminar_producto(id):
    conn = get_db_connection()
    
    producto = conn.execute('SELECT * FROM productos WHERE id = ?', (id,)).fetchone()
    if producto:
        # También eliminar los costos asociados a este producto
        conn.execute('DELETE FROM costos_productos WHERE producto_id = ?', (id,))
        conn.execute('DELETE FROM productos WHERE id = ?', (id,))
        conn.commit()
        flash(f'Producto "{producto["nombre"]}" eliminado correctamente', 'success')
    
    conn.close()
    return redirect(url_for('datos_iniciales'))

# ==================== VIABILIDAD TÉCNICA ====================

# ==================== VIABILIDAD TÉCNICA ====================

@app.route('/proyecto/viabilidad-tecnica')
def viabilidad_tecnica():
    conn = get_db_connection()
    
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    # Obtener productos
    productos = []
    if proyecto:
        productos = conn.execute('SELECT * FROM productos WHERE proyecto_id = ? ORDER BY id', 
                               (proyecto['id'],)).fetchall()
    
    # Costos generales
    costos_generales = []
    total_costos_generales = 0
    if proyecto:
        costos_generales = conn.execute('SELECT * FROM costos_generales WHERE proyecto_id = ? ORDER BY id', 
                                       (proyecto['id'],)).fetchall()
        total_costos_generales_result = conn.execute('SELECT SUM(valor) as total FROM costos_generales WHERE proyecto_id = ?', 
                                                   (proyecto['id'],)).fetchone()
        total_costos_generales = total_costos_generales_result['total'] or 0 if total_costos_generales_result else 0
    
    # Costos por producto
    costos_por_producto = {}
    total_costos_productos = 0
    if productos:
        for producto in productos:
            costos_producto = conn.execute('SELECT * FROM costos_productos WHERE producto_id = ? ORDER BY id', 
                                         (producto['id'],)).fetchall()
            
            # Calcular total por producto
            total_producto_result = conn.execute('SELECT SUM(valor) as total FROM costos_productos WHERE producto_id = ?', 
                                               (producto['id'],)).fetchone()
            total_producto = total_producto_result['total'] or 0 if total_producto_result else 0
            
            costos_por_producto[producto['id']] = {
                'producto': producto,
                'costos': costos_producto,
                'total': total_producto
            }
            
            total_costos_productos += total_producto
    
    gastos = []
    total_gastos = 0
    if proyecto:
        gastos = conn.execute('SELECT * FROM gastos WHERE proyecto_id = ? ORDER BY id', 
                             (proyecto['id'],)).fetchall()
        total_gastos_result = conn.execute('SELECT SUM(valor) as total FROM gastos WHERE proyecto_id = ?', 
                                         (proyecto['id'],)).fetchone()
        total_gastos = total_gastos_result['total'] or 0 if total_gastos_result else 0
    
    conn.close()
    
    return render_template('proyecto/viabilidad_tecnica.html', 
                         proyecto=proyecto,
                         productos=productos,
                         costos_generales=costos_generales,
                         total_costos_generales=total_costos_generales,
                         costos_por_producto=costos_por_producto,
                         total_costos_productos=total_costos_productos,
                         gastos=gastos,
                         total_gastos=total_gastos)
# Nueva función para agregar costo a un producto específico
# ==================== COSTOS POR PRODUCTO ====================

@app.route('/proyecto/agregar-costo-producto/<int:producto_id>', methods=['POST'])
def agregar_costo_producto(producto_id):
    if request.method == 'POST':
        nombre = request.form.get('nombre_costo_producto')
        valor = float(request.form.get('valor_costo_producto', 0))
        
        conn = get_db_connection()
        
        # Verificar que el producto existe
        producto = conn.execute('SELECT * FROM productos WHERE id = ?', (producto_id,)).fetchone()
        if producto:
            conn.execute('INSERT INTO costos_productos (producto_id, nombre, valor) VALUES (?, ?, ?)',
                        (producto_id, nombre, valor))
            conn.commit()
            flash(f'Costo para "{producto["nombre"]}" agregado correctamente', 'success')
        else:
            flash('Producto no encontrado', 'error')
        
        conn.close()
    
    return redirect(url_for('viabilidad_tecnica'))

@app.route('/proyecto/editar-costo-producto/<int:id>', methods=['POST'])
def editar_costo_producto(id):
    if request.method == 'POST':
        nombre = request.form.get('nombre_costo_producto')
        valor = float(request.form.get('valor_costo_producto', 0))
        
        conn = get_db_connection()
        conn.execute('UPDATE costos_productos SET nombre = ?, valor = ? WHERE id = ?',
                    (nombre, valor, id))
        conn.commit()
        conn.close()
        
        flash(f'Costo por producto actualizado correctamente', 'success')
    
    return redirect(url_for('viabilidad_tecnica'))

@app.route('/proyecto/eliminar-costo-producto/<int:id>')
def eliminar_costo_producto(id):
    conn = get_db_connection()
    
    costo = conn.execute('SELECT * FROM costos_productos WHERE id = ?', (id,)).fetchone()
    if costo:
        conn.execute('DELETE FROM costos_productos WHERE id = ?', (id,))
        conn.commit()
        flash(f'Costo por producto eliminado correctamente', 'success')
    
    conn.close()
    return redirect(url_for('viabilidad_tecnica'))

@app.route('/proyecto/agregar-costo', methods=['POST'])
def agregar_costo():
    if request.method == 'POST':
        nombre = request.form.get('nombre_costo')
        valor = float(request.form.get('valor_costo', 0))
        
        conn = get_db_connection()
        proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
        
        if proyecto:
            conn.execute('INSERT INTO costos_generales (proyecto_id, nombre, valor) VALUES (?, ?, ?)',
                        (proyecto['id'], nombre, valor))
            conn.commit()
            flash(f'Costo general "{nombre}" agregado correctamente', 'success')
        else:
            flash('Primero debes crear un proyecto', 'warning')
        
        conn.close()
    
    return redirect(url_for('viabilidad_tecnica'))

@app.route('/proyecto/editar-costo/<int:id>', methods=['POST'])
def editar_costo(id):
    conn = get_db_connection()
    
    if request.method == 'POST':
        nombre = request.form.get('nombre_costo')
        valor = float(request.form.get('valor_costo', 0))
        
        conn.execute('UPDATE costos_generales SET nombre = ?, valor = ? WHERE id = ?',
                    (nombre, valor, id))
        conn.commit()
        conn.close()
        
        flash(f'Costo general actualizado correctamente', 'success')
        return redirect(url_for('viabilidad_tecnica'))
    
    costo = conn.execute('SELECT * FROM costos_generales WHERE id = ?', (id,)).fetchone()
    conn.close()
    
    if not costo:
        flash('Costo no encontrado', 'error')
        return redirect(url_for('viabilidad_tecnica'))
    
    return render_template('componentes/modal_editar_costo.html', costo=costo)

@app.route('/proyecto/eliminar-costo/<int:id>')
def eliminar_costo(id):
    conn = get_db_connection()
    
    costo = conn.execute('SELECT * FROM costos_generales WHERE id = ?', (id,)).fetchone()
    if costo:
        conn.execute('DELETE FROM costos_generales WHERE id = ?', (id,))
        conn.commit()
        flash(f'Costo general "{costo["nombre"]}" eliminado correctamente', 'success')
    
    conn.close()
    return redirect(url_for('viabilidad_tecnica'))

# @app.route('/proyecto/viabilidad-tecnica')
# def viabilidad_tecnica():
#     conn = get_db_connection()
    
#     proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
#     costos = []
#     total_costos = 0
#     if proyecto:
#         costos = conn.execute('SELECT * FROM costos WHERE proyecto_id = ? ORDER BY id', 
#                              (proyecto['id'],)).fetchall()
#         total_costos_result = conn.execute('SELECT SUM(valor) as total FROM costos WHERE proyecto_id = ?', 
#                                          (proyecto['id'],)).fetchone()
#         total_costos = total_costos_result['total'] or 0 if total_costos_result else 0
    
#     gastos = []
#     total_gastos = 0
#     if proyecto:
#         gastos = conn.execute('SELECT * FROM gastos WHERE proyecto_id = ? ORDER BY id', 
#                              (proyecto['id'],)).fetchall()
#         total_gastos_result = conn.execute('SELECT SUM(valor) as total FROM gastos WHERE proyecto_id = ?', 
#                                          (proyecto['id'],)).fetchone()
#         total_gastos = total_gastos_result['total'] or 0 if total_gastos_result else 0
    
#     conn.close()
    
#     return render_template('proyecto/viabilidad_tecnica.html', 
#                          proyecto=proyecto, 
#                          costos=costos, 
#                          gastos=gastos,
#                          total_costos=total_costos,
#                          total_gastos=total_gastos)

# @app.route('/proyecto/agregar-costo', methods=['POST'])
# def agregar_costo():
#     if request.method == 'POST':
#         nombre = request.form.get('nombre_costo')
#         valor = float(request.form.get('valor_costo', 0))
        
#         conn = get_db_connection()
#         proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
        
#         if proyecto:
#             conn.execute('INSERT INTO costos (proyecto_id, nombre, valor) VALUES (?, ?, ?)',
#                         (proyecto['id'], nombre, valor))
#             conn.commit()
#             flash(f'Costo "{nombre}" agregado correctamente', 'success')
#         else:
#             flash('Primero debes crear un proyecto', 'warning')
        
#         conn.close()
    
#     return redirect(url_for('viabilidad_tecnica'))

# @app.route('/proyecto/editar-costo/<int:id>', methods=['GET', 'POST'])
# def editar_costo(id):
#     conn = get_db_connection()
    
#     if request.method == 'POST':
#         nombre = request.form.get('nombre_costo')
#         valor = float(request.form.get('valor_costo', 0))
        
#         conn.execute('UPDATE costos SET nombre = ?, valor = ? WHERE id = ?',
#                     (nombre, valor, id))
#         conn.commit()
#         conn.close()
        
#         flash(f'Costo actualizado correctamente', 'success')
#         return redirect(url_for('viabilidad_tecnica'))
    
#     costo = conn.execute('SELECT * FROM costos WHERE id = ?', (id,)).fetchone()
#     conn.close()
    
#     if not costo:
#         flash('Costo no encontrado', 'error')
#         return redirect(url_for('viabilidad_tecnica'))
    
#     return render_template('componentes/modal_editar_costo.html', costo=costo)

# @app.route('/proyecto/eliminar-costo/<int:id>')
# def eliminar_costo(id):
#     conn = get_db_connection()
    
#     costo = conn.execute('SELECT * FROM costos WHERE id = ?', (id,)).fetchone()
#     if costo:
#         conn.execute('DELETE FROM costos WHERE id = ?', (id,))
#         conn.commit()
#         flash(f'Costo "{costo["nombre"]}" eliminado correctamente', 'success')
    
#     conn.close()
#     return redirect(url_for('viabilidad_tecnica'))

@app.route('/proyecto/agregar-gasto', methods=['POST'])
def agregar_gasto():
    if request.method == 'POST':
        nombre = request.form.get('nombre_gasto')
        valor = float(request.form.get('valor_gasto', 0))
        
        conn = get_db_connection()
        proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
        
        if proyecto:
            conn.execute('INSERT INTO gastos (proyecto_id, nombre, valor) VALUES (?, ?, ?)',
                        (proyecto['id'], nombre, valor))
            conn.commit()
            flash(f'Gasto "{nombre}" agregado correctamente', 'success')
        else:
            flash('Primero debes crear un proyecto', 'warning')
        
        conn.close()
    
    return redirect(url_for('viabilidad_tecnica'))

@app.route('/proyecto/editar-gasto/<int:id>', methods=['GET', 'POST'])
def editar_gasto(id):
    conn = get_db_connection()
    
    if request.method == 'POST':
        nombre = request.form.get('nombre_gasto')
        valor = float(request.form.get('valor_gasto', 0))
        
        conn.execute('UPDATE gastos SET nombre = ?, valor = ? WHERE id = ?',
                    (nombre, valor, id))
        conn.commit()
        conn.close()
        
        flash(f'Gasto actualizado correctamente', 'success')
        return redirect(url_for('viabilidad_tecnica'))
    
    gasto = conn.execute('SELECT * FROM gastos WHERE id = ?', (id,)).fetchone()
    conn.close()
    
    if not gasto:
        flash('Gasto no encontrado', 'error')
        return redirect(url_for('viabilidad_tecnica'))
    
    return render_template('componentes/modal_editar_gasto.html', gasto=gasto)

@app.route('/proyecto/eliminar-gasto/<int:id>')
def eliminar_gasto(id):
    conn = get_db_connection()
    
    gasto = conn.execute('SELECT * FROM gastos WHERE id = ?', (id,)).fetchone()
    if gasto:
        conn.execute('DELETE FROM gastos WHERE id = ?', (id,))
        conn.commit()
        flash(f'Gasto "{gasto["nombre"]}" eliminado correctamente', 'success')
    
    conn.close()
    return redirect(url_for('viabilidad_tecnica'))

# ==================== VIABILIDAD OPERATIVA ====================

@app.route('/proyecto/viabilidad-operativa')
def viabilidad_operativa():
    conn = get_db_connection()
    
    # Obtener proyecto actual
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        conn.close()
        flash('Primero debes crear un proyecto', 'warning')
        return redirect(url_for('datos_iniciales'))
    
    # Obtener productos (opcional, para mostrar info)
    productos = []
    productos = conn.execute('SELECT * FROM productos WHERE proyecto_id = ? ORDER BY id', 
                           (proyecto['id'],)).fetchall()
    
    # Obtener personal
    personal = []
    total_salarios = 0
    personal = conn.execute('SELECT * FROM personal WHERE proyecto_id = ? ORDER BY id', 
                           (proyecto['id'],)).fetchall()
    
    total_salarios_result = conn.execute('SELECT SUM(salario_mensual) as total FROM personal WHERE proyecto_id = ?', 
                                       (proyecto['id'],)).fetchone()
    total_salarios = total_salarios_result['total'] or 0 if total_salarios_result else 0
    
    # Obtener costos generales (NO costos, es costos_generales)
    total_costos_generales = 0
    total_costos_result = conn.execute('SELECT SUM(valor) as total FROM costos_generales WHERE proyecto_id = ?', 
                                     (proyecto['id'],)).fetchone()
    total_costos_generales = total_costos_result['total'] or 0 if total_costos_result else 0
    
    # Obtener costos por producto
    total_costos_productos = 0
    if productos:
        for producto in productos:
            total_producto_result = conn.execute('SELECT SUM(valor) as total FROM costos_productos WHERE producto_id = ?', 
                                               (producto['id'],)).fetchone()
            total_producto = total_producto_result['total'] or 0 if total_producto_result else 0
            total_costos_productos += total_producto
    
    # Obtener gastos
    total_gastos = 0
    total_gastos_result = conn.execute('SELECT SUM(valor) as total FROM gastos WHERE proyecto_id = ?', 
                                     (proyecto['id'],)).fetchone()
    total_gastos = total_gastos_result['total'] or 0 if total_gastos_result else 0
    
    conn.close()
    
    # Calcular total general
    total_general = total_costos_generales + total_costos_productos + total_gastos + total_salarios
    
    return render_template('proyecto/viabilidad_operativa.html', 
                         proyecto=proyecto,
                         productos=productos,
                         personal=personal,
                         total_salarios=total_salarios,
                         total_costos_generales=total_costos_generales,
                         total_costos_productos=total_costos_productos,
                         total_gastos=total_gastos,
                         total_general=total_general)

@app.route('/proyecto/agregar-personal', methods=['POST'])
def agregar_personal():
    if request.method == 'POST':
        nombre = request.form.get('nombre_personal')
        perfil = request.form.get('perfil_personal')
        salario_mensual = float(request.form.get('salario_mensual', 0))
        
        conn = get_db_connection()
        proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
        
        if proyecto:
            conn.execute('INSERT INTO personal (proyecto_id, nombre, perfil, salario_mensual) VALUES (?, ?, ?, ?)',
                        (proyecto['id'], nombre, perfil, salario_mensual))
            conn.commit()
            flash(f'Personal "{nombre}" agregado correctamente', 'success')
        else:
            flash('Primero debes crear un proyecto', 'warning')
        
        conn.close()
    
    return redirect(url_for('viabilidad_operativa'))

@app.route('/proyecto/editar-personal/<int:id>', methods=['GET', 'POST'])
def editar_personal(id):
    conn = get_db_connection()
    
    if request.method == 'POST':
        nombre = request.form.get('nombre_personal')
        perfil = request.form.get('perfil_personal')
        salario_mensual = float(request.form.get('salario_mensual', 0))
        
        conn.execute('UPDATE personal SET nombre = ?, perfil = ?, salario_mensual = ? WHERE id = ?',
                    (nombre, perfil, salario_mensual, id))
        conn.commit()
        conn.close()
        
        flash(f'Personal actualizado correctamente', 'success')
        return redirect(url_for('viabilidad_operativa'))
    
    persona = conn.execute('SELECT * FROM personal WHERE id = ?', (id,)).fetchone()
    conn.close()
    
    if not persona:
        flash('Personal no encontrado', 'error')
        return redirect(url_for('viabilidad_operativa'))
    
    return render_template('componentes/modal_editar_personal.html', persona=persona)

@app.route('/proyecto/eliminar-personal/<int:id>')
def eliminar_personal(id):
    conn = get_db_connection()
    
    persona = conn.execute('SELECT * FROM personal WHERE id = ?', (id,)).fetchone()
    if persona:
        conn.execute('DELETE FROM personal WHERE id = ?', (id,))
        conn.commit()
        flash(f'Personal "{persona["nombre"]}" eliminado correctamente', 'success')
    
    conn.close()
    return redirect(url_for('viabilidad_operativa'))

# ==================== EQUIPO Y MAQUINARIA ====================

@app.route('/proyecto/equipo-maquinaria')
def equipo_maquinaria():
    conn = get_db_connection()
    
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    materiales = []
    total_materiales = 0
    if proyecto:
        materiales = conn.execute('SELECT * FROM materiales WHERE proyecto_id = ? ORDER BY id', 
                                 (proyecto['id'],)).fetchall()
        total_materiales_result = conn.execute('SELECT SUM(valor) as total FROM materiales WHERE proyecto_id = ?', 
                                             (proyecto['id'],)).fetchone()
        total_materiales = total_materiales_result['total'] or 0 if total_materiales_result else 0
    
    total_costos = 0
    total_gastos = 0
    total_salarios = 0
    if proyecto:
        total_costos_result = conn.execute('SELECT SUM(valor) as total FROM costos WHERE proyecto_id = ?', 
                                         (proyecto['id'],)).fetchone()
        total_costos = total_costos_result['total'] or 0 if total_costos_result else 0
        
        total_gastos_result = conn.execute('SELECT SUM(valor) as total FROM gastos WHERE proyecto_id = ?', 
                                         (proyecto['id'],)).fetchone()
        total_gastos = total_gastos_result['total'] or 0 if total_gastos_result else 0
        
        total_salarios_result = conn.execute('SELECT SUM(salario_mensual) as total FROM personal WHERE proyecto_id = ?', 
                                           (proyecto['id'],)).fetchone()
        total_salarios = total_salarios_result['total'] or 0 if total_salarios_result else 0
    
    conn.close()
    
    return render_template('proyecto/equipo_maquinaria.html', 
                         proyecto=proyecto, 
                         materiales=materiales,
                         total_materiales=total_materiales,
                         total_costos=total_costos,
                         total_gastos=total_gastos,
                         total_salarios=total_salarios)

@app.route('/proyecto/agregar-material', methods=['POST'])
def agregar_material():
    if request.method == 'POST':
        nombre = request.form.get('nombre_material')
        valor = float(request.form.get('valor_material', 0))
        
        conn = get_db_connection()
        proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
        
        if proyecto:
            conn.execute('INSERT INTO materiales (proyecto_id, nombre, valor) VALUES (?, ?, ?)',
                        (proyecto['id'], nombre, valor))
            conn.commit()
            flash(f'Material "{nombre}" agregado correctamente', 'success')
        else:
            flash('Primero debes crear un proyecto', 'warning')
        
        conn.close()
    
    return redirect(url_for('equipo_maquinaria'))

@app.route('/proyecto/editar-material/<int:id>', methods=['GET', 'POST'])
def editar_material(id):
    conn = get_db_connection()
    
    if request.method == 'POST':
        nombre = request.form.get('nombre_material')
        valor = float(request.form.get('valor_material', 0))
        
        conn.execute('UPDATE materiales SET nombre = ?, valor = ? WHERE id = ?',
                    (nombre, valor, id))
        conn.commit()
        conn.close()
        
        flash(f'Material actualizado correctamente', 'success')
        return redirect(url_for('equipo_maquinaria'))
    
    material = conn.execute('SELECT * FROM materiales WHERE id = ?', (id,)).fetchone()
    conn.close()
    
    if not material:
        flash('Material no encontrado', 'error')
        return redirect(url_for('equipo_maquinaria'))
    
    return render_template('componentes/modal_editar_material.html', material=material)

@app.route('/proyecto/eliminar-material/<int:id>')
def eliminar_material(id):
    conn = get_db_connection()
    
    material = conn.execute('SELECT * FROM materiales WHERE id = ?', (id,)).fetchone()
    if material:
        conn.execute('DELETE FROM materiales WHERE id = ?', (id,))
        conn.commit()
        flash(f'Material "{material["nombre"]}" eliminado correctamente', 'success')
    
    conn.close()
    return redirect(url_for('equipo_maquinaria'))

# ==================== FLUJOS DE CAJA ====================

@app.route('/proyecto/flujos-caja')
def flujos_caja():
    conn = get_db_connection()
    
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    totales = {
        'costos': 0,
        'gastos': 0,
        'salarios': 0,
        'materiales': 0
    }
    
    ventas_dias = None
    ventas_semanas = None
    ventas_meses = None
    ventas_anos = None
    
    # Obtener INGRESOS (nuevo)
    ingresos_dias = None
    ingresos_semanas = None
    ingresos_meses = None
    ingresos_anos = None

    
    if proyecto:
        # Costos
        total_costos_result = conn.execute('SELECT SUM(valor) as total FROM costos WHERE proyecto_id = ?', 
                                         (proyecto['id'],)).fetchone()
        totales['costos'] = total_costos_result['total'] or 0 if total_costos_result else 0
        
        # Gastos
        total_gastos_result = conn.execute('SELECT SUM(valor) as total FROM gastos WHERE proyecto_id = ?', 
                                         (proyecto['id'],)).fetchone()
        totales['gastos'] = total_gastos_result['total'] or 0 if total_gastos_result else 0
        
        # Personal
        total_salarios_result = conn.execute('SELECT SUM(salario_mensual) as total FROM personal WHERE proyecto_id = ?', 
                                           (proyecto['id'],)).fetchone()
        totales['salarios'] = total_salarios_result['total'] or 0 if total_salarios_result else 0
        
        # Materiales
        total_materiales_result = conn.execute('SELECT SUM(valor) as total FROM materiales WHERE proyecto_id = ?', 
                                             (proyecto['id'],)).fetchone()
        totales['materiales'] = total_materiales_result['total'] or 0 if total_materiales_result else 0
        
        # Obtener ventas
        ventas_dias = conn.execute('SELECT * FROM ventas_dias WHERE proyecto_id = ?', 
                                  (proyecto['id'],)).fetchone()
        ventas_semanas = conn.execute('SELECT * FROM ventas_semanas WHERE proyecto_id = ?', 
                                     (proyecto['id'],)).fetchone()
        ventas_meses = conn.execute('SELECT * FROM ventas_meses WHERE proyecto_id = ?', 
                                   (proyecto['id'],)).fetchone()
        ventas_anos = conn.execute('SELECT * FROM ventas_anos WHERE proyecto_id = ?', 
                                  (proyecto['id'],)).fetchone()
    
        # Obtener ingresos (NUEVO)
        ingresos_dias = conn.execute('SELECT * FROM ingresos_dias WHERE proyecto_id = ?', 
                                   (proyecto['id'],)).fetchone()
        ingresos_semanas = conn.execute('SELECT * FROM ingresos_semanas WHERE proyecto_id = ?', 
                                      (proyecto['id'],)).fetchone()
        ingresos_meses = conn.execute('SELECT * FROM ingresos_meses WHERE proyecto_id = ?', 
                                    (proyecto['id'],)).fetchone()
        ingresos_anos = conn.execute('SELECT * FROM ingresos_anos WHERE proyecto_id = ?', 
                                   (proyecto['id'],)).fetchone()
        
    conn.close()
    
    return render_template('proyecto/flujos_caja.html', 
                         proyecto=proyecto,
                         totales=totales,
                         ventas_dias=ventas_dias,
                         ventas_semanas=ventas_semanas,
                         ventas_meses=ventas_meses,
                         ventas_anos=ventas_anos,
                         # Nuevos parámetros
                         ingresos_dias=ingresos_dias,
                         ingresos_semanas=ingresos_semanas,
                         ingresos_meses=ingresos_meses,
                         ingresos_anos=ingresos_anos)

@app.route('/proyecto/guardar-ventas-dias', methods=['POST'])
def guardar_ventas_dias():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'lunes': int(request.form.get('lunes', 0)),
        'martes': int(request.form.get('martes', 0)),
        'miercoles': int(request.form.get('miercoles', 0)),
        'jueves': int(request.form.get('jueves', 0)),
        'viernes': int(request.form.get('viernes', 0)),
        'sabado': int(request.form.get('sabado', 0)),
        'domingo': int(request.form.get('domingo', 0))
    }
    
    datos_ingresos = {
        'lunes': float(request.form.get('ingresos_lunes', 0)),
        'martes': float(request.form.get('ingresos_martes', 0)),
        'miercoles': float(request.form.get('ingresos_miercoles', 0)),
        'jueves': float(request.form.get('ingresos_jueves', 0)),
        'viernes': float(request.form.get('ingresos_viernes', 0)),
        'sabado': float(request.form.get('ingresos_sabado', 0)),
        'domingo': float(request.form.get('ingresos_domingo', 0))
    }
    
    existente = conn.execute('SELECT * FROM ventas_dias WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ventas_dias SET 
            lunes = ?, martes = ?, miercoles = ?, jueves = ?, 
            viernes = ?, sabado = ?, domingo = ?
            WHERE proyecto_id = ?
        ''', (datos['lunes'], datos['martes'], datos['miercoles'], datos['jueves'],
              datos['viernes'], datos['sabado'], datos['domingo'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ventas_dias 
            (proyecto_id, lunes, martes, miercoles, jueves, viernes, sabado, domingo)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['lunes'], datos['martes'], datos['miercoles'], 
              datos['jueves'], datos['viernes'], datos['sabado'], datos['domingo']))
    
    # Guardar INGRESOS (si decides guardarlos aquí también)
    existente_ingresos = conn.execute('SELECT * FROM ingresos_dias WHERE proyecto_id = ?', 
                                    (proyecto['id'],)).fetchone()
    
    if existente_ingresos:
        conn.execute('''
            UPDATE ingresos_dias SET 
            lunes = ?, martes = ?, miercoles = ?, jueves = ?, 
            viernes = ?, sabado = ?, domingo = ?
            WHERE proyecto_id = ?
        ''', (datos_ingresos['lunes'], datos_ingresos['martes'], datos_ingresos['miercoles'], datos_ingresos['jueves'],
              datos_ingresos['viernes'], datos_ingresos['sabado'], datos_ingresos['domingo'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ingresos_dias 
            (proyecto_id, lunes, martes, miercoles, jueves, viernes, sabado, domingo)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos_ingresos['lunes'], datos_ingresos['martes'], datos_ingresos['miercoles'], 
              datos_ingresos['jueves'], datos_ingresos['viernes'], datos_ingresos['sabado'], datos_ingresos['domingo']))
    
    conn.commit()
    conn.close()
    
    flash('Ventas por día guardadas correctamente', 'success')
    return redirect(url_for('flujos_caja'))

@app.route('/proyecto/guardar-ventas-semanas', methods=['POST'])
def guardar_ventas_semanas():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'semana1': int(request.form.get('semana1', 0)),
        'semana2': int(request.form.get('semana2', 0)),
        'semana3': int(request.form.get('semana3', 0)),
        'semana4': int(request.form.get('semana4', 0))
    }
    
    existente = conn.execute('SELECT * FROM ventas_semanas WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ventas_semanas SET 
            semana1 = ?, semana2 = ?, semana3 = ?, semana4 = ?
            WHERE proyecto_id = ?
        ''', (datos['semana1'], datos['semana2'], datos['semana3'], 
              datos['semana4'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ventas_semanas 
            (proyecto_id, semana1, semana2, semana3, semana4)
            VALUES (?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['semana1'], datos['semana2'], 
              datos['semana3'], datos['semana4']))
    
    conn.commit()
    conn.close()
    
    flash('Ventas por semana guardadas correctamente', 'success')
    return redirect(url_for('flujos_caja'))

@app.route('/proyecto/guardar-ventas-meses', methods=['POST'])
def guardar_ventas_meses():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'enero': int(request.form.get('enero', 0)),
        'febrero': int(request.form.get('febrero', 0)),
        'marzo': int(request.form.get('marzo', 0)),
        'abril': int(request.form.get('abril', 0)),
        'mayo': int(request.form.get('mayo', 0)),
        'junio': int(request.form.get('junio', 0)),
        'julio': int(request.form.get('julio', 0))
    }
    
    existente = conn.execute('SELECT * FROM ventas_meses WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ventas_meses SET 
            enero = ?, febrero = ?, marzo = ?, abril = ?, 
            mayo = ?, junio = ?, julio = ?
            WHERE proyecto_id = ?
        ''', (datos['enero'], datos['febrero'], datos['marzo'], datos['abril'],
              datos['mayo'], datos['junio'], datos['julio'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ventas_meses 
            (proyecto_id, enero, febrero, marzo, abril, mayo, junio, julio)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['enero'], datos['febrero'], datos['marzo'], 
              datos['abril'], datos['mayo'], datos['junio'], datos['julio']))
    
    conn.commit()
    conn.close()
    
    flash('Ventas por mes guardadas correctamente', 'success')
    return redirect(url_for('flujos_caja'))

@app.route('/proyecto/guardar-ventas-anos', methods=['POST'])
def guardar_ventas_anos():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'año1': int(request.form.get('año1', 0)),
        'año2': int(request.form.get('año2', 0)),
        'año3': int(request.form.get('año3', 0)),
        'año4': int(request.form.get('año4', 0)),
        'año5': int(request.form.get('año5', 0)),
        'año6': int(request.form.get('año6', 0)),
        'año7': int(request.form.get('año7', 0))
    }
    
    existente = conn.execute('SELECT * FROM ventas_anos WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ventas_anos SET 
            año1 = ?, año2 = ?, año3 = ?, año4 = ?, 
            año5 = ?, año6 = ?, año7 = ?
            WHERE proyecto_id = ?
        ''', (datos['año1'], datos['año2'], datos['año3'], datos['año4'],
              datos['año5'], datos['año6'], datos['año7'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ventas_anos 
            (proyecto_id, año1, año2, año3, año4, año5, año6, año7)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['año1'], datos['año2'], datos['año3'], 
              datos['año4'], datos['año5'], datos['año6'], datos['año7']))
    
    conn.commit()
    conn.close()
    
    flash('Ventas por año guardadas correctamente', 'success')
    return redirect(url_for('flujos_caja'))

# ==================== INGRESOS ====================

@app.route('/proyecto/guardar-ingresos-dias', methods=['POST'])
def guardar_ingresos_dias():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'lunes': float(request.form.get('lunes_ingreso', 0)),
        'martes': float(request.form.get('martes_ingreso', 0)),
        'miercoles': float(request.form.get('miercoles_ingreso', 0)),
        'jueves': float(request.form.get('jueves_ingreso', 0)),
        'viernes': float(request.form.get('viernes_ingreso', 0)),
        'sabado': float(request.form.get('sabado_ingreso', 0)),
        'domingo': float(request.form.get('domingo_ingreso', 0))
    }
    
    existente = conn.execute('SELECT * FROM ingresos_dias WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ingresos_dias SET 
            lunes = ?, martes = ?, miercoles = ?, jueves = ?, 
            viernes = ?, sabado = ?, domingo = ?
            WHERE proyecto_id = ?
        ''', (datos['lunes'], datos['martes'], datos['miercoles'], datos['jueves'],
              datos['viernes'], datos['sabado'], datos['domingo'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ingresos_dias 
            (proyecto_id, lunes, martes, miercoles, jueves, viernes, sabado, domingo)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['lunes'], datos['martes'], datos['miercoles'], 
              datos['jueves'], datos['viernes'], datos['sabado'], datos['domingo']))
    
    conn.commit()
    conn.close()
    
    flash('Ingresos por día guardados correctamente', 'success')
    return redirect(url_for('flujos_caja'))

# Repite lo mismo para semanas, meses y años
# (copia las funciones de ventas y cambia "ventas" por "ingresos")

@app.route('/proyecto/guardar-ingresos-semanas', methods=['POST'])
def guardar_ingresos_semanas():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'semana1': int(request.form.get('semana1', 0)),
        'semana2': int(request.form.get('semana2', 0)),
        'semana3': int(request.form.get('semana3', 0)),
        'semana4': int(request.form.get('semana4', 0))
    }
    
    existente = conn.execute('SELECT * FROM ingresos_semanas WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ingresos_semanas SET 
            semana1 = ?, semana2 = ?, semana3 = ?, semana4 = ?
            WHERE proyecto_id = ?
        ''', (datos['semana1'], datos['semana2'], datos['semana3'], 
              datos['semana4'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ingresos_semanas 
            (proyecto_id, semana1, semana2, semana3, semana4)
            VALUES (?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['semana1'], datos['semana2'], 
              datos['semana3'], datos['semana4']))
    
    conn.commit()
    conn.close()
    
    flash('Ingresos por semana guardadas correctamente', 'success')
    return redirect(url_for('flujos_caja'))

@app.route('/proyecto/guardar-ingresos-meses', methods=['POST'])
def guardar_ingresos_meses():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'enero': int(request.form.get('enero', 0)),
        'febrero': int(request.form.get('febrero', 0)),
        'marzo': int(request.form.get('marzo', 0)),
        'abril': int(request.form.get('abril', 0)),
        'mayo': int(request.form.get('mayo', 0)),
        'junio': int(request.form.get('junio', 0)),
        'julio': int(request.form.get('julio', 0))
    }
    
    existente = conn.execute('SELECT * FROM ingresos_meses WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ingresos_meses SET 
            enero = ?, febrero = ?, marzo = ?, abril = ?, 
            mayo = ?, junio = ?, julio = ?
            WHERE proyecto_id = ?
        ''', (datos['enero'], datos['febrero'], datos['marzo'], datos['abril'],
              datos['mayo'], datos['junio'], datos['julio'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ingresos_meses 
            (proyecto_id, enero, febrero, marzo, abril, mayo, junio, julio)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['enero'], datos['febrero'], datos['marzo'], 
              datos['abril'], datos['mayo'], datos['junio'], datos['julio']))
    
    conn.commit()
    conn.close()
    
    flash('Ingresos por mes guardadas correctamente', 'success')
    return redirect(url_for('flujos_caja'))

@app.route('/proyecto/guardar-ingresos-anos', methods=['POST'])
def guardar_ingresos_anos():
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('flujos_caja'))
    
    datos = {
        'año1': int(request.form.get('año1', 0)),
        'año2': int(request.form.get('año2', 0)),
        'año3': int(request.form.get('año3', 0)),
        'año4': int(request.form.get('año4', 0)),
        'año5': int(request.form.get('año5', 0)),
        'año6': int(request.form.get('año6', 0)),
        'año7': int(request.form.get('año7', 0))
    }
    
    existente = conn.execute('SELECT * FROM ingresos_anos WHERE proyecto_id = ?', 
                            (proyecto['id'],)).fetchone()
    
    if existente:
        conn.execute('''
            UPDATE ingresos_anos SET 
            año1 = ?, año2 = ?, año3 = ?, año4 = ?, 
            año5 = ?, año6 = ?, año7 = ?
            WHERE proyecto_id = ?
        ''', (datos['año1'], datos['año2'], datos['año3'], datos['año4'],
              datos['año5'], datos['año6'], datos['año7'], proyecto['id']))
    else:
        conn.execute('''
            INSERT INTO ingresos_anos 
            (proyecto_id, año1, año2, año3, año4, año5, año6, año7)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        ''', (proyecto['id'], datos['año1'], datos['año2'], datos['año3'], 
              datos['año4'], datos['año5'], datos['año6'], datos['año7']))
    
    conn.commit()
    conn.close()
    
    flash('ingresos por año guardadas correctamente', 'success')
    return redirect(url_for('flujos_caja'))

# ==================== FUNCIONES DE CÁLCULO ====================

def calcular_van(tasa_descuento, flujos):
    """Calcula el VAN dado una tasa de descuento y una lista de flujos."""
    van = 0
    for i, flujo in enumerate(flujos):
        van += flujo / ((1 + tasa_descuento) ** i)
    return van

def calcular_tir(flujos, iteraciones=1000, precision=0.0001):
    """Calcula la TIR usando el método de bisección."""
    def van_con_tasa(tasa):
        total = 0
        for i, flujo in enumerate(flujos):
            total += flujo / ((1 + tasa) ** i)
        return total
    
    tasa_min = -0.99
    tasa_max = 10.0
    
    van_min = van_con_tasa(tasa_min)
    van_max = van_con_tasa(tasa_max)
    
    if van_min * van_max > 0:
        return None
    
    for _ in range(iteraciones):
        tasa_media = (tasa_min + tasa_max) / 2
        van_media = van_con_tasa(tasa_media)
        
        if abs(van_media) < precision:
            return tasa_media
        
        if van_min * van_media < 0:
            tasa_max = tasa_media
            van_max = van_media
        else:
            tasa_min = tasa_media
            van_min = van_media
    
    return (tasa_min + tasa_max) / 2

def calcular_bc(flujos, tasa_descuento):
    """Calcula la relación Beneficio/Costo."""
    beneficios_pv = 0
    costos_pv = 0
    
    for i, flujo in enumerate(flujos):
        if flujo > 0:
            beneficios_pv += flujo / ((1 + tasa_descuento) ** i)
        else:
            costos_pv += abs(flujo) / ((1 + tasa_descuento) ** i)
    
    if costos_pv == 0:
        return float('inf')
    
    return beneficios_pv / costos_pv

def calcular_pri(flujos):
    """Calcula el Periodo de Recuperación de la Inversión."""
    inversion_inicial = abs(flujos[0]) if flujos and flujos[0] < 0 else 0
    if inversion_inicial == 0:
        return 0
    
    acumulado = 0
    
    for i, flujo in enumerate(flujos):
        if i == 0:
            continue
        
        acumulado += flujo
        
        if acumulado >= inversion_inicial:
            flujo_anterior = flujos[i-1] if i > 1 else 0
            faltante_antes = inversion_inicial - (acumulado - flujo)
            proporcion = faltante_antes / flujo if flujo != 0 else 0
            
            return (i - 1) + proporcion
    
    return None

# Función helper para plantillas
def calcular_van_template(tasa, flujos):
    """Versión para usar en plantillas Jinja2"""
    return calcular_van(tasa, flujos)

@app.context_processor
def utility_processor():
    """Inyecta funciones en todas las plantillas"""
    return dict(calcular_van=calcular_van_template)


def calcular_resumen_ventas(ventas_dias):
    """Calcula resumen de ventas por día"""
    if ventas_dias is None:
        return {'total': 0, 'dias_activos': 0, 'promedio': 0}
    
    # Convertir a diccionario si es SQLite Row
    if hasattr(ventas_dias, 'keys'):
        ventas = dict(ventas_dias)
    else:
        ventas = ventas_dias or {}
    
    dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo']
    total = 0
    dias_activos = 0
    
    for dia in dias:
        venta = ventas.get(dia, 0)
        if venta and venta > 0:
            total += venta
            dias_activos += 1
    
    return {
        'total': total,
        'dias_activos': dias_activos,
        'promedio': total / dias_activos if dias_activos > 0 else 0
    }

def calcular_resumen_ingresos(ingresos_dias):
    """Calcula resumen de ingresos por día"""
    if not ingresos_dias:
        return {'total': 0, 'promedio_diario': 0}
    
    dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo']
    total = 0
    
    for dia in dias:
        ingreso = ingresos_dias.get(dia, 0)
        total += ingreso
    
    return {
        'total': total,
        'promedio_diario': total / 7
    }

# ==================== CÁLCULOS FINANCIEROS ====================

@app.route('/resultados/calculos-financieros')
def calculos_financieros():
    conn = get_db_connection()
    
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        flash('Primero debes crear un proyecto', 'warning')
        conn.close()
        return redirect(url_for('index'))
    
    resultados = {
        'proyecto': proyecto,
        'totales': {},
        'calculos': {},
        'ventas': {},    # Nuevo: para datos de ventas
        'ingresos': {}   # Nuevo: para datos de ingresos
    }
    
    # Obtener totales
    # Costos
    total_costos_result = conn.execute('SELECT SUM(valor) as total FROM costos WHERE proyecto_id = ?', 
                                     (proyecto['id'],)).fetchone()
    resultados['totales']['costos'] = total_costos_result['total'] or 0 if total_costos_result else 0
    
    # Gastos
    total_gastos_result = conn.execute('SELECT SUM(valor) as total FROM gastos WHERE proyecto_id = ?', 
                                     (proyecto['id'],)).fetchone()
    resultados['totales']['gastos'] = total_gastos_result['total'] or 0 if total_costos_result else 0
    
    # Personal
    total_salarios_result = conn.execute('SELECT SUM(salario_mensual) as total FROM personal WHERE proyecto_id = ?', 
                                       (proyecto['id'],)).fetchone()
    resultados['totales']['salarios'] = total_salarios_result['total'] or 0 if total_salarios_result else 0
    
    # Materiales
    total_materiales_result = conn.execute('SELECT SUM(valor) as total FROM materiales WHERE proyecto_id = ?', 
                                         (proyecto['id'],)).fetchone()
    resultados['totales']['materiales'] = total_materiales_result['total'] or 0 if total_materiales_result else 0
    
    # Inversión inicial
    inversion_inicial = proyecto['valor_inversion'] if proyecto['tiene_inversion'] == 1 else 0
    
    # Obtener ventas por año para flujos
    ventas_anos = conn.execute('SELECT * FROM ventas_anos WHERE proyecto_id = ?', 
                              (proyecto['id'],)).fetchone()
    
    # ========== OBTENER DATOS DE VENTAS ==========
    # Obtener ventas
    ventas_dias = conn.execute('SELECT * FROM ventas_dias WHERE proyecto_id = ?', 
                                  (proyecto['id'],)).fetchone()
    ventas_semanas = conn.execute('SELECT * FROM ventas_semanas WHERE proyecto_id = ?', 
                                     (proyecto['id'],)).fetchone()
    ventas_meses = conn.execute('SELECT * FROM ventas_meses WHERE proyecto_id = ?', 
                                   (proyecto['id'],)).fetchone()
    ventas_anos = conn.execute('SELECT * FROM ventas_anos WHERE proyecto_id = ?', 
                                  (proyecto['id'],)).fetchone()
    
    resultados['ventas'] = {
        'anos': ventas_anos,
        'meses': ventas_meses,
        'semanas': ventas_semanas,
        'dias': ventas_dias
    }
    
    # ========== OBTENER DATOS DE INGRESOS ==========
    ingresos_anos = conn.execute('SELECT * FROM ingresos_anos WHERE proyecto_id = ?', 
                                (proyecto['id'],)).fetchone()
    ingresos_meses = conn.execute('SELECT * FROM ingresos_meses WHERE proyecto_id = ?', 
                                 (proyecto['id'],)).fetchone()
    ingresos_semanas = conn.execute('SELECT * FROM ingresos_semanas WHERE proyecto_id = ?', 
                                   (proyecto['id'],)).fetchone()
    ingresos_dias = conn.execute('SELECT * FROM ingresos_dias WHERE proyecto_id = ?', 
                                (proyecto['id'],)).fetchone()
    
    resultados['ingresos'] = {
        'anos': ingresos_anos,
        'meses': ingresos_meses,
        'semanas': ingresos_semanas,
        'dias': ingresos_dias
    }
    
    conn.close()
    
    # ========== CALCULAR TOTALES DE VENTAS/INGRESOS ==========
    
    # Total ventas anuales (suma de los 7 años)
    total_ventas_anuales = 0
    if ventas_anos:
        for i in range(1, 8):
            año_key = f'año{i}'
            if año_key in ventas_anos.keys():
                total_ventas_anuales += ventas_anos[año_key] or 0
    
    # Total ingresos anuales (suma de los 7 años)
    total_ingresos_anuales = 0
    if ingresos_anos:
        for i in range(1, 8):
            año_key = f'año{i}'
            if año_key in ingresos_anos.keys():
                total_ingresos_anuales += ingresos_anos[año_key] or 0
    
    resultados['calculos']['total_ventas_anuales'] = total_ventas_anuales
    resultados['calculos']['total_ingresos_anuales'] = total_ingresos_anuales
    
    # ========== CALCULAR PROMEDIOS ==========
    
    # Si no hay ingresos directos, calcularlos desde ventas
    if total_ingresos_anuales == 0 and total_ventas_anuales > 0:
        # Asumir que ingresos = ventas * precio del primer producto
        productos = obtener_productos_actuales()  # Tu función existente
        if productos and len(productos) > 0:
            precio_promedio = productos[0]['precio']  # O calcular promedio
            total_ingresos_anuales = total_ventas_anuales * precio_promedio
    
    resultados['calculos']['ingresos_promedio_anual'] = total_ingresos_anuales / 7 if total_ingresos_anuales > 0 else 0
    
    # Construir flujos de caja para 7 años
    flujos_anuales = []
    
    # Año 0: Inversión inicial (negativa)
    flujos_anuales.append(-inversion_inicial)
    
    # Años 1-7: Flujos netos
    if ventas_anos:
        # Calcular ingresos anuales usando get()
        for i in range(1, 8):
            ventas_key = f'año{i}'
            # Usar get() en lugar de getattr para mayor seguridad
            ventas = ventas_anos[ventas_key] if ventas_key in ventas_anos.keys() else 0
            ingresos_anuales = ventas * proyecto['precio_producto']
            
            # Calcular flujo neto
            costo_anual = resultados['totales']['costos'] / 7 if resultados['totales']['costos'] > 0 else 0
            gasto_anual = resultados['totales']['gastos'] / 7 if resultados['totales']['gastos'] > 0 else 0
            salario_anual = resultados['totales']['salarios'] * 12 if resultados['totales']['salarios'] > 0 else 0
            
            flujo_neto = ingresos_anuales - costo_anual - gasto_anual - salario_anual
            flujos_anuales.append(flujo_neto)
    else:
        # Valores por defecto si no hay ventas registradas
        for i in range(7):
            flujos_anuales.append(0)
    
    # Realizar cálculos financieros
    tasa_descuento = proyecto['tasa_descuento']
    
    try:
        # VAN
        van = calcular_van(tasa_descuento, flujos_anuales)
        resultados['calculos']['van'] = van
        
        # TIR
        tir = calcular_tir(flujos_anuales)
        resultados['calculos']['tir'] = tir * 100 if tir else 0
        
        # B/C
        bc = calcular_bc(flujos_anuales, tasa_descuento)
        resultados['calculos']['bc'] = bc
        
        # PRI
        pri = calcular_pri(flujos_anuales)
        resultados['calculos']['pri'] = pri
        
        # Otros indicadores
        resultados['calculos']['flujos'] = flujos_anuales
        resultados['calculos']['inversion_total'] = (
            inversion_inicial + 
            resultados['totales']['costos'] + 
            resultados['totales']['gastos'] + 
            (resultados['totales']['salarios'] * 12 * 7) +  # 7 años de salarios
            resultados['totales']['materiales']
        )
        
        # Rentabilidad
        if inversion_inicial > 0:
            resultados['calculos']['rentabilidad'] = (van / inversion_inicial) * 100
        else:
            resultados['calculos']['rentabilidad'] = 0
            
    except Exception as e:
        resultados['calculos']['error'] = f"Error en cálculos: {str(e)}"
        resultados['calculos']['van'] = 0
        resultados['calculos']['tir'] = 0
        resultados['calculos']['bc'] = 0
        resultados['calculos']['pri'] = 0
        resultados['calculos']['flujos'] = flujos_anuales
        resultados['calculos']['inversion_total'] = 0
        resultados['calculos']['rentabilidad'] = 0
    
    # CALCULAR RESUMEN DE VENTAS
    resumen_ventas = calcular_resumen_ventas(ventas_dias)
    
    # ¡IMPORTANTE: PASAR resumen_ventas AL TEMPLATE!
    return render_template('resultados/calculo_financiero.html',
                        resultados=resultados,
                        ventas_anos=ventas_anos,
                        ingresos_anos=ingresos_anos,
                        productos=productos,
                        resumen_ventas=resumen_ventas)  # ¡ESTA LÍNEA ES LA CLAVE!  # También pasa productos
    

def obtener_proyecto_actual():
    """Obtiene el proyecto actual"""
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    conn.close()
    return proyecto

def obtener_productos_actuales():
    """Obtiene los productos del proyecto actual"""
    proyecto = obtener_proyecto_actual()
    if not proyecto:
        return []
    
    conn = get_db_connection()
    productos = conn.execute('SELECT * FROM productos WHERE proyecto_id = ? ORDER BY id', 
                           (proyecto['id'],)).fetchall()
    conn.close()
    return productos

# Añade esta función en app.py
def contar_productos():
    """Retorna solo el número de productos del proyecto actual"""
    conn = get_db_connection()
    
    # Primero obtener el proyecto actual
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    if not proyecto:
        conn.close()
        return 0
    
    # Contar productos
    resultado = conn.execute('SELECT COUNT(*) as total FROM productos WHERE proyecto_id = ?', 
                           (proyecto['id'],)).fetchone()
    
    conn.close()
    return resultado['total'] if resultado else 0

# Después de get_db_connection()
def calcular_total_costos_productos():
    """Calcula el total de costos de todos los productos"""
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    total = 0
    if proyecto:
        productos = conn.execute('SELECT id FROM productos WHERE proyecto_id = ?', 
                               (proyecto['id'],)).fetchall()
        
        for producto in productos:
            resultado = conn.execute('SELECT SUM(valor) as total FROM costos_productos WHERE producto_id = ?', 
                                   (producto['id'],)).fetchone()
            total_producto = resultado['total'] or 0 if resultado else 0
            total += total_producto
    
    conn.close()
    return total

def calcular_total_costos_generales():
    """Calcula el total de costos generales"""
    conn = get_db_connection()
    proyecto = conn.execute('SELECT * FROM proyectos ORDER BY id DESC LIMIT 1').fetchone()
    
    total = 0
    if proyecto:
        resultado = conn.execute('SELECT SUM(valor) as total FROM costos_generales WHERE proyecto_id = ?', 
                               (proyecto['id'],)).fetchone()
        total = resultado['total'] or 0 if resultado else 0
    
    conn.close()
    return total

# Hacerlas disponibles en todos los templates
@app.context_processor
def inject_calculos():
    return {
        'total_costos_productos': calcular_total_costos_productos,
        'total_costos_generales': calcular_total_costos_generales,
        'contar_productos': contar_productos  # La que ya tienes
    }

# Ruta para limpiar todos los datos
@app.route('/limpiar-datos')
def limpiar_datos():
    conn = get_db_connection()
    
    conn.execute('DELETE FROM costos')
    conn.execute('DELETE FROM gastos')
    conn.execute('DELETE FROM personal')
    conn.execute('DELETE FROM materiales')
    conn.execute('DELETE FROM ventas_dias')
    conn.execute('DELETE FROM ventas_semanas')
    conn.execute('DELETE FROM ventas_meses')
    conn.execute('DELETE FROM ventas_anos')
    
    conn.commit()
    conn.close()
    
    flash('Todos los datos han sido limpiados (excepto el proyecto)', 'warning')
    return redirect(url_for('index'))

if __name__ == '__main__':
    app.run(debug=True, port=5000)


proyecto-pep-v2/config.py:
import os
from dotenv import load_dotenv

# Cargar variables del archivo .env
load_dotenv()

class Config:
    # Configuración básica
    SECRET_KEY = os.getenv('SECRET_KEY', 'clave_por_defecto_segura')
    
    # Configuración de base de datos SQLite
    BASE_DIR = os.path.abspath(os.path.dirname(__file__))
    DATABASE_PATH = os.path.join(BASE_DIR, 'database', 'proyecto_pep.db')
    SQLALCHEMY_DATABASE_URI = f'sqlite:///{DATABASE_PATH}'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # Configuraciones de la aplicación
    DEBUG = os.getenv('FLASK_ENV') == 'development'

proyecto-pep-v2/requirements.txt:
Flask==2.3.3
python-dotenv==1.0.0
gunicorn==21.2.0

proyecto-pep-v2/runtime.txt:
python-3.10

proyecto-pep-v2/static/css/style.css:
/* Estilos generales */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
    color: #333;
    padding-bottom: 60px;
}

/* Mejoras para tarjetas */
.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid #e0e0e0;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

/* Estilos para formularios */
.form-control:focus {
    border-color: #4dabf7;
    box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
}

/* Botones personalizados */
.btn {
    border-radius: 6px;
    padding: 8px 20px;
    font-weight: 500;
}

/* Tablas */
.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-top: none;
}

/* Alertas */
.alert {
    border-radius: 8px;
    border: none;
}

/* Navegación */
.navbar-brand {
    font-weight: 700;
    font-size: 1.4rem;
}

/* Pie de página */
footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 1000;
}

/* Contenedor principal */
.container {
    max-width: 1200px;
}

/* Responsive */
@media (max-width: 768px) {
    .display-4 {
        font-size: 2rem;
    }
    
    .card {
        margin-bottom: 15px;
    }
}

/* Colores personalizados */
.bg-purple {
    background-color: #6f42c1 !important;
}

.text-purple {
    color: #6f42c1 !important;
}


/* Estilos para la sección de equipo y maquinaria */
.bg-purple {
    background-color: #6f42c1 !important;
}

.text-purple {
    color: #6f42c1 !important;
}

.btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
}

.btn-purple:hover {
    background-color: #5a32a3;
    border-color: #5a32a3;
    color: white;
}

/* Mejoras para checkboxes y radios */
.form-check-input:checked {
    background-color: #6f42c1;
    border-color: #6f42c1;
}

/* Espaciado para botones en navegación */
.d-flex.justify-content-between .btn {
    min-width: 200px;
}


proyecto-pep-v2/templates/componentes/modal_editar_costo.html:
<div class="modal fade" id="modalEditarCosto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Editar Costo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_costo', id=costo.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_costo" class="form-label">Nombre del costo:</label>
                        <input type="text" class="form-control" id="nombre_costo" 
                               name="nombre_costo" value="{{ costo.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valor_costo" class="form-label">Valor (Bs):</label>
                        <input type="number" class="form-control" id="valor_costo" 
                               name="valor_costo" value="{{ costo.valor }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

proyecto-pep-v2/templates/componentes/modal_editar_gasto.html:
<div class="modal fade" id="modalEditarGasto" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Editar Gasto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_gasto', id=gasto.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_gasto" class="form-label">Nombre del gasto:</label>
                        <input type="text" class="form-control" id="nombre_gasto" 
                               name="nombre_gasto" value="{{ gasto.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valor_gasto" class="form-label">Valor:</label>
                        <input type="number" class="form-control" id="valor_gasto" 
                               name="valor_gasto" value="{{ gasto.valor }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

proyecto-pep-v2/templates/componentes/modal_editar_material.html:
<div class="modal fade" id="modalEditarMaterial" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Editar Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_material', id=material.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_material" class="form-label">Nombre del material:</label>
                        <input type="text" class="form-control" id="nombre_material" 
                               name="nombre_material" value="{{ material.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valor_material" class="form-label">Valor:</label>
                        <input type="number" class="form-control" id="valor_material" 
                               name="valor_material" value="{{ material.valor }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>


proyecto-pep-v2/templates/componentes/modal_editar_personal.html:
<div class="modal fade" id="modalEditarPersonal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Editar Personal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_personal', id=persona.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_personal" class="form-label">Nombre:</label>
                        <input type="text" class="form-control" id="nombre_personal" 
                               name="nombre_personal" value="{{ persona.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="perfil_personal" class="form-label">Perfil:</label>
                        <textarea class="form-control" id="perfil_personal" 
                                  name="perfil_personal" rows="3">{{ persona.perfil }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="salario_mensual" class="form-label">Salario Mensual:</label>
                        <input type="number" class="form-control" id="salario_mensual" 
                               name="salario_mensual" value="{{ persona.salario_mensual }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

proyecto-pep-v2/templates/componentes/modal_editar_producto.html:
<div class="modal fade" id="modalEditarProducto{{ producto.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_producto', id=producto.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_producto_{{ producto.id }}" class="form-label">Nombre del producto:</label>
                        <input type="text" class="form-control" id="nombre_producto_{{ producto.id }}" 
                               name="nombre_producto" value="{{ producto.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="precio_producto_{{ producto.id }}" class="form-label">Precio (Bs):</label>
                        <input type="number" class="form-control" id="precio_producto_{{ producto.id }}" 
                               name="precio_producto" value="{{ producto.precio }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

proyecto-pep-v2/templates/proyecto/datos_iniciales.html:
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">📋 PRIMERA FASE: Datos Iniciales</h2>
            {% if proyecto %}
            <span class="badge bg-success">Proyecto: {{ proyecto.nombre }}</span>
            {% endif %}
        </div>
        
        <!-- Información del Excel -->
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">ℹ️ Descripcion:</h5>
            <p class="mb-0">Esta sección corresponde a la <strong>"PRIMERA FASE: Datos iniciales"</strong>. 
            Aquí configuras los datos básicos del proyecto que se usarán en todas las fases siguientes.</p>
        </div>

        <!-- Formulario del proyecto -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Datos del Proyecto</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('datos_iniciales') }}">
                    
                    <!-- Fila 1: Nombre del proyecto -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nombre" class="form-label">
                                    <strong>nombre del proyecto:</strong>
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="nombre" name="nombre" 
                                       value="{{ proyecto.nombre if proyecto else '' }}"
                                       placeholder="Ej: empresa de prueba" required>
                                <div class="form-text">
                                    <small>se ingresara nombre del proyecto</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fila 2: Tipo de actividad -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_actividad" class="form-label">
                                    <strong>tipo de actividad:</strong>
                                </label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="tipo_actividad" name="tipo_actividad" 
                                       value="{{ proyecto.tipo_actividad if proyecto else '' }}"
                                       placeholder="Ej: venta de articulos" required>
                                <div class="form-text">
                                    <small>una descripcion pequeña sobre el proyecto</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fila 3: Inversión inicial -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">
                                    <strong>inversion inicial:</strong>
                                </label>
                                <div class="d-flex align-items-center">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" 
                                               name="tiene_inversion" id="inversion_si" 
                                               value="si" 
                                               {% if proyecto and proyecto.tiene_inversion == 1 %}checked{% endif %}>
                                        <label class="form-check-label" for="inversion_si">si</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" 
                                               name="tiene_inversion" id="inversion_no" 
                                               value="no" 
                                               {% if not proyecto or proyecto.tiene_inversion == 0 %}checked{% endif %}>
                                        <label class="form-check-label" for="inversion_no">no</label>
                                    </div>
                                </div>
                                <div class="form-text">
                                    <small>aquí habrá un checkbox donde se elegirá si tiene o no inversión inicial</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="campo_valor_inversion" 
                                 style="display: {% if proyecto and proyecto.tiene_inversion == 1 %}block{% else %}none{% endif %};">
                                <label for="valor_inversion" class="form-label">
                                    <strong>valor de la inversión inicial:</strong>
                                </label>
                                <input type="number" class="form-control" 
                                       id="valor_inversion" name="valor_inversion" 
                                       value="{{ proyecto.valor_inversion if proyecto else 0 }}"
                                       step="0.01" min="0">
                                <div class="form-text">
                                    <small>si tiene inversión inicial aparecerá esta opción</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fila 4: Tasa de descuento -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tasa_descuento" class="form-label">
                                    <strong>tasas de descuento:</strong>
                                </label>
                                <input type="number" class="form-control form-control-lg" 
                                       id="tasa_descuento" name="tasa_descuento" 
                                       value="{{ proyecto.tasa_descuento if proyecto else 0.001 }}"
                                       step="0.001" min="0" max="1" required>
                                <div class="form-text">
                                    <small>aquí ingresaremos la tasa en porcentaje (ej: 0.001 = 0.1%)</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botón para guardar proyecto -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            ← Volver al Inicio
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            {% if proyecto %}Actualizar Proyecto{% else %}Crear Proyecto{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CRUD de Productos -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">📦 Productos del Proyecto</h5>
            </div>
            <div class="card-body">
                <!-- Formulario para agregar producto -->
                <form method="POST" action="{{ url_for('agregar_producto') }}" id="formProducto" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre_producto" class="form-label">
                                <strong>Nombre del producto:</strong>
                            </label>
                            <input type="text" class="form-control" id="nombre_producto" 
                                   name="nombre_producto" placeholder="Ej: PC gamer" required>
                            <div class="form-text">
                                <small>Nombre del producto que evaluaremos</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="precio_producto" class="form-label">
                                <strong>Precio del producto (Bs):</strong>
                            </label>
                            <input type="number" class="form-control" id="precio_producto" 
                                   name="precio_producto" step="0.01" min="0" value="2000" required>
                            <div class="form-text">
                                <small>Precio de venta del producto</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-info w-100">
                                ➕ Añadir Producto
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Tabla de productos -->
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Nro</th>
                                <th>Producto</th>
                                <th width="150">Precio (Bs)</th>
                                <th width="150" class="text-center">Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ producto.nombre }}</td>
                                <td class="text-end">{{ producto.precio|round(2) }}</td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-outline-warning"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEditarProducto{{ producto.id }}">
                                        Editar
                                    </button>
                                    <a href="{{ url_for('eliminar_producto', id=producto.id) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Eliminar este producto?')">
                                        Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No hay productos registrados. Agrega el primero.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Resumen si hay proyecto -->
        {% if proyecto %}
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">📊 Resumen del Proyecto</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr>
                                <th>PROYECTO:</th>
                                <td>{{ proyecto.nombre }}</td>
                            </tr>
                            <tr>
                                <th>Actividad:</th>
                                <td>{{ proyecto.tipo_actividad }}</td>
                            </tr>
                            <tr>
                                <th>Inversión:</th>
                                <td>{{ 'Sí' if proyecto.tiene_inversion == 1 else 'No' }}</td>
                            </tr>
                            <tr>
                                <th>Tasa:</th>
                                <td>{{ (proyecto.tasa_descuento * 100)|round(3) }}%</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr>
                                <th colspan="2" class="text-center bg-light">PRODUCTOS</th>
                            </tr>
                            {% for producto in productos %}
                            <tr>
                                <td>{{ producto.nombre }}</td>
                                <td>Bs {{ producto.precio|round(2) }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">Sin productos</td>
                            </tr>
                            {% endfor %}
                            <tr class="table-light">
                                <td><strong>Total Productos:</strong></td>
                                <td><strong>{{ productos|length }}</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Botón para siguiente fase -->
        {% if proyecto and productos|length > 0 %}
        <div class="text-center mt-4">
            <a href="{{ url_for('viabilidad_tecnica') }}" class="btn btn-success btn-lg">
                Siguiente: Viabilidad Técnica →
            </a>
        </div>
        {% elif proyecto %}
        <div class="alert alert-warning mt-4">
            <h5>⚠️ Agrega al menos un producto</h5>
            <p>Para continuar con la siguiente fase, necesitas agregar al menos un producto.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modales para editar productos -->
{% for producto in productos %}
<div class="modal fade" id="modalEditarProducto{{ producto.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_producto', id=producto.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_producto_{{ producto.id }}" class="form-label">Nombre del producto:</label>
                        <input type="text" class="form-control" id="nombre_producto_{{ producto.id }}" 
                               name="nombre_producto" value="{{ producto.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="precio_producto_{{ producto.id }}" class="form-label">Precio (Bs):</label>
                        <input type="number" class="form-control" id="precio_producto_{{ producto.id }}" 
                               name="precio_producto" value="{{ producto.precio }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    // Mostrar/ocultar campo de valor de inversión
    document.querySelectorAll('input[name="tiene_inversion"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const campoValor = document.getElementById('campo_valor_inversion');
            campoValor.style.display = this.value === 'si' ? 'block' : 'none';
            
            // Si selecciona "no", establecer valor a 0
            if (this.value === 'no') {
                document.getElementById('valor_inversion').value = 0;
            }
        });
    });

    // Formatear tasa como porcentaje al perder foco
    document.getElementById('tasa_descuento').addEventListener('blur', function() {
        let valor = parseFloat(this.value);
        if (!isNaN(valor)) {
            this.value = valor.toFixed(4); // 4 decimales como en Excel
        }
    });

    // Formatear precio del producto
    document.getElementById('precio_producto').addEventListener('blur', function() {
        let valor = parseFloat(this.value);
        if (!isNaN(valor)) {
            this.value = valor.toFixed(2); // 2 decimales
        }
    });
</script>

<!-- Modales para editar productos -->
{% for producto in productos %}
<div class="modal fade" id="modalEditarProducto{{ producto.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Editar Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_producto', id=producto.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_producto_{{ producto.id }}" class="form-label">Nombre del producto:</label>
                        <input type="text" class="form-control" id="nombre_producto_{{ producto.id }}" 
                               name="nombre_producto" value="{{ producto.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="precio_producto_{{ producto.id }}" class="form-label">Precio:</label>
                        <input type="number" class="form-control" id="precio_producto_{{ producto.id }}" 
                               name="precio_producto" value="{{ producto.precio }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

proyecto-pep-v2/templates/proyecto/equipo_maquinaria.html:
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">🔩 Equipo y Maquinaria</h2>
            {% if proyecto %}
            <div>
                <span class="badge bg-primary">Proyecto: {{ proyecto.nombre }}</span>
                <span class="badge bg-info">INVERSIÓN</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Información del Excel -->
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">ℹ️ Descripcion:</h5>
            <p class="mb-0">Esta sección corresponde a la parte de <strong>"Equipo y maquinaria"</strong>. 
            Aquí gestionas los materiales, equipos e inversiones necesarias para el proyecto.</p>
        </div>

        <!-- Advertencia si no hay proyecto -->
        {% if not proyecto %}
        <div class="alert alert-warning">
            <h5>⚠️ Primero debes crear un proyecto</h5>
            <p>Para gestionar materiales, primero necesitas crear un proyecto en la sección "Datos Iniciales".</p>
            <a href="{{ url_for('datos_iniciales') }}" class="btn btn-warning">Ir a Datos Iniciales →</a>
        </div>
        {% else %}
        
        <!-- Formulario para agregar material -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">INVERSION</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('agregar_material') }}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre_material" class="form-label">
                                <strong>nombre del material</strong>
                            </label>
                            <input type="text" class="form-control" id="nombre_material" 
                                   name="nombre_material" placeholder="Ej: letrero grande" required>
                            <div class="form-text">
                                <small>Nombre del equipo, maquinaria o material</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="valor_material" class="form-label">
                                <strong>precio del costo:</strong>
                            </label>
                            <input type="number" class="form-control" id="valor_material" 
                                   name="valor_material" step="0.01" min="0" required>
                            <div class="form-text">
                                <small>Valor de la inversión en $</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-info w-100">
                                ➕ añadir material
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de materiales -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Lista de Materiales</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Nro</th>
                                <th>Lista de materiales</th>
                                <th width="120">Valor</th>
                                <th width="150" class="text-center">opcion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in materiales %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ material.nombre }}</td>
                                <td class="text-end">$ {{ material.valor|round(2) }}</td>
                                <td class="text-center">
                                    <!-- Botón para editar (abrirá modal) -->
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEditarMaterial{{ material.id }}">
                                        Editar
                                    </button>
                                    <a href="{{ url_for('eliminar_material', id=material.id) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Seguro que quieres eliminar este material?')">
                                        Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No hay materiales registrados. Agrega tu primer material o equipo.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="2" class="text-end"><strong>TOTAL materiales:</strong></td>
                                <td class="text-end"><strong>Bs {{ total_materiales|round(2) }}</strong></td>
                                <td class="text-center">
                                    <small>Nro materiales: {{ materiales|length }}</small>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Resumen completo -->
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">📊 DATOS PREVIOS - Resumen Completo</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Datos del proyecto -->
                    <div class="col-md-4">
                        <table class="table table-bordered">
                            <tr>
                                <th>PROYECTO:</th>
                                <td>{{ proyecto.nombre }}</td>
                            </tr>
                            <tr>
                                <th>Actividad:</th>
                                <td>{{ proyecto.tipo_actividad }}</td>
                            </tr>
                            <tr>
                                <th>Inversión:</th>
                                <td>{{ 'Sí' if proyecto.tiene_inversion == 1 else 'No' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table class="table table-bordered">
                            <tr>
                                <th>Tasa:</th>
                                <td>{{ (proyecto.tasa_descuento * 100)|round(3) }}%</td>
                            </tr>
                            <tr>
                                <th>Productos en Total:</th>
                                <td>{{ contar_productos() }}</td>
                            </tr>
                            <tr>
                                <th>Valor Inversion:</th>
                                <td>Bs {{ proyecto.valor_inversion|round(2) }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Totales acumulados -->
                    <div class="col-md-4">
                        <div class="card bg-light h-100">
                            <div class="card-body">
                                <h6 class="card-title text-center mb-3">TOTALES ACUMULADOS</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Costos de Productos:</span>
                                    <strong class="text-success">Bs {{ total_costos_productos()|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Costos Generales:</span>
                                    <strong class="text-success">Bs {{ total_costos_generales()|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Gastos:</span>
                                    <strong class="text-warning">Bs {{ total_gastos|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Salarios:</span>
                                    <strong class="text-danger">Bs {{ total_salarios|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Materiales:</span>
                                    <strong class="text-info">Bs {{ total_materiales|round(2) }}</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total General:</strong>
                                    <strong>Bs {{ (total_costos_productos()+total_costos_generales() + total_gastos + total_salarios + total_materiales)|round(2) }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selector de flujo (como en tu Excel) -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-purple text-white">
                <h5 class="mb-0">⏰ Configuración de Flujos</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-light mb-4">
                    <p class="mb-0">
                        <strong>⚠️ Nota:</strong> Estos parámetros serán como un check box, según lo que se elija mostrará su respectivo flujo.
                    </p>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label"><strong>elegir opcion:</strong></label>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_dias" value="dias" checked>
                                <label class="form-check-label" for="flujo_dias">
                                    flujo por dias
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_semanas" value="semanas">
                                <label class="form-check-label" for="flujo_semanas">
                                    flujo por semanas
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_meses" value="meses">
                                <label class="form-check-label" for="flujo_meses">
                                    flujo por meses
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_anos" value="anos">
                                <label class="form-check-label" for="flujo_anos">
                                    flujo por años
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de navegación -->
        <div class="d-flex justify-content-between mt-4">
            <div>
                <a href="{{ url_for('viabilidad_operativa') }}" class="btn btn-outline-secondary">
                    ← volver: Viabilidad operativa
                </a>
            </div>
            <div>
                <a href="{{ url_for('flujos_caja') }}" class="btn btn-primary">
                    Siguiente: Flujos de caja →
                </a>
            </div>
        </div>
        
        {% endif %} <!-- Fin del if proyecto -->
    </div>
</div>

<!-- Modales para editar materiales -->
{% for material in materiales %}
<div class="modal fade" id="modalEditarMaterial{{ material.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Editar Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_material', id=material.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_material_{{ material.id }}" class="form-label">Nombre del material:</label>
                        <input type="text" class="form-control" id="nombre_material_{{ material.id }}" 
                               name="nombre_material" value="{{ material.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valor_material_{{ material.id }}" class="form-label">Valor:</label>
                        <input type="number" class="form-control" id="valor_material_{{ material.id }}" 
                               name="valor_material" value="{{ material.valor }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<style>
    .bg-purple {
        background-color: #6f42c1 !important;
    }
</style>
<script>
    // Formatear valores al perder foco
    document.querySelectorAll('input[name="valor_material"]').forEach(input => {
        input.addEventListener('blur', function() {
            let valor = parseFloat(this.value);
            if (!isNaN(valor)) {
                this.value = valor.toFixed(2); // 2 decimales
            }
        });
    });

    // Guardar selección de tipo de flujo
    document.querySelectorAll('input[name="tipo_flujo"]').forEach(radio => {
        radio.addEventListener('change', function() {
            localStorage.setItem('tipo_flujo_seleccionado', this.value);
        });
    });

    // Cargar selección guardada
    window.addEventListener('DOMContentLoaded', function() {
        const tipoGuardado = localStorage.getItem('tipo_flujo_seleccionado');
        if (tipoGuardado) {
            document.getElementById('flujo_' + tipoGuardado).checked = true;
        }
    });
</script>
{% endblock %}

proyecto-pep-v2/templates/proyecto/flujos_caja.html:
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">💰 Flujos de Caja</h2>
            {% if proyecto %}
            <div>
                <span class="badge bg-primary">Proyecto: {{ proyecto.nombre }}</span>
                <!-- <span class="badge bg-success">Producto: {{ proyecto.nombre_producto }}</span> -->
            </div>
            {% endif %}
        </div>
        
        <!-- Información del Excel -->
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">ℹ️ Descripcion:</h5>
            <p class="mb-0">En esta de <strong>"Flujos de caja"</strong> calcularemos: 
            Las definiciones de las ventas por periodo y se calculan automáticamente los ingresos, costos, gastos, egresos y utilidad bruta.</p>
        </div>

        <!-- Advertencia si no hay proyecto -->
        {% if not proyecto %}
        <div class="alert alert-warning">
            <h5>⚠️ Primero debes crear un proyecto</h5>
            <p>Para configurar flujos de caja, primero necesitas crear un proyecto en la sección "Datos Iniciales".</p>
            <a href="{{ url_for('datos_iniciales') }}" class="btn btn-warning">Ir a Datos Iniciales →</a>
        </div>
        {% else %}
        
        <!-- Selector de tipo de flujo -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-purple text-white">
                <h5 class="mb-0">⏰ Elegir Periodo de Análisis</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-light mb-4">
                    <p class="mb-0">
                        <strong>⚠️ Nota:</strong> Estos flujos de abajo cambiarán según el tipo de flujo escogido anteriormente.
                    </p>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label"><strong>elegir opcion:</strong></label>
                        <div class="d-flex flex-wrap gap-3 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_dias" value="dias" 
                                       onclick="mostrarFlujo('dias')" 
                                       {% if request.args.get('tipo') != 'semanas' and request.args.get('tipo') != 'meses' and request.args.get('tipo') != 'anos' %}checked{% endif %}>
                                <label class="form-check-label" for="flujo_dias">
                                    flujo por dias
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_semanas" value="semanas" 
                                       onclick="mostrarFlujo('semanas')"
                                       {% if request.args.get('tipo') == 'semanas' %}checked{% endif %}>
                                <label class="form-check-label" for="flujo_semanas">
                                    flujo por semanas
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_meses" value="meses" 
                                       onclick="mostrarFlujo('meses')"
                                       {% if request.args.get('tipo') == 'meses' %}checked{% endif %}>
                                <label class="form-check-label" for="flujo_meses">
                                    flujo por meses
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_flujo" 
                                       id="flujo_anos" value="anos" 
                                       onclick="mostrarFlujo('anos')"
                                       {% if request.args.get('tipo') == 'anos' %}checked{% endif %}>
                                <label class="form-check-label" for="flujo_anos">
                                    flujo por años
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen de datos previos -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">📊 DATOS PREVIOS</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Datos del proyecto -->
                    <div class="col-md-4">
                        <table class="table table-bordered">
                            <tr>
                                <th>PROYECTO:</th>
                                <td>{{ proyecto.nombre }}</td>
                            </tr>
                            <tr>
                                <th>Actividad:</th>
                                <td>{{ proyecto.tipo_actividad }}</td>
                            </tr>
                            <tr>
                                <th>Inversión:</th>
                                <td>{{ 'Sí' if proyecto.tiene_inversion == 1 else 'No' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table class="table table-bordered">
                            <tr>
                                <th>Tasa:</th>
                                <td>{{ (proyecto.tasa_descuento * 100)|round(3) }}%</td>
                            </tr>
                            <tr>
                                <th>Producto en Total:</th>
                                <td>{{ contar_productos() }}</td>
                            </tr>
                            <tr>
                                <th>Valor Inversion:</th>
                                <td>Bs {{ proyecto.valor_inversion|round(2) }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Totales acumulados -->
                    <div class="col-md-4">
                        <div class="card bg-light h-100">
                            <div class="card-body">
                                <h6 class="card-title text-center mb-3">TOTALES ACUMULADOS</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Costos de Productos:</span>
                                    <strong class="text-success">Bs {{ total_costos_productos()|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Costos Generales:</span>
                                    <strong class="text-success">Bs {{ total_costos_generales()|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Gastos:</span>
                                    <strong class="text-warning">Bs {{ totales.gastos|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Salarios:</span>
                                    <strong class="text-danger">Bs {{ totales.salarios|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Materiales:</span>
                                    <strong class="text-info">Bs {{ totales.materiales|round(2) }}</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total General:</strong>
                                    <strong>Bs {{ (total_costos_productos() + total_costos_generales() + totales.gastos + totales.salarios + totales.materiales)|round(2) }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== FLUJO POR DÍAS ========== -->
        <div id="flujo_dias_container" class="flujo-container">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">📅 Flujo por Días</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('guardar_ventas_dias') }}">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>flujo por dias</th>
                                        <th>lunes</th>
                                        <th>martes</th>
                                        <th>miércoles</th>
                                        <th>jueves</th>
                                        <th>viernes</th>
                                        <th>sábado</th>
                                        <th>domingo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="table-secondary"><strong>Nro de productos vendidos</strong></td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="lunes" value="{{ ventas_dias.lunes if ventas_dias else 4 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="martes" value="{{ ventas_dias.martes if ventas_dias else 3 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="miercoles" value="{{ ventas_dias.miercoles if ventas_dias else 2 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="jueves" value="{{ ventas_dias.jueves if ventas_dias else 4 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="viernes" value="{{ ventas_dias.viernes if ventas_dias else 6 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="sabado" value="{{ ventas_dias.sabado if ventas_dias else 10 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="domingo" value="{{ ventas_dias.domingo if ventas_dias else 4 }}" min="0">
                                        </td>
                                    </tr>
                                    
                                    <!-- Cálculos automáticos -->
                                    {% if ventas_dias %}
                                    <tr class="table-success">
                                        <td><strong>Ingresos</strong></td>

                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="ingresos_lunes" value="{{ ingresos_dias.lunes if ingresos_dias else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="ingresos_martes" value="{{ ingresos_dias.martes if ingresos_dias else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="ingresos_miercoles" value="{{ ingresos_dias.miercoles if ingresos_dias else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="ingresos_jueves" value="{{ ingresos_dias.jueves if ingresos_dias else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="ingresos_viernes" value="{{ ingresos_dias.viernes if ingresos_dias else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="ingresos_sabado" value="{{ ingresos_dias.sabado if ingresos_dias else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="ingresos_domingo" value="{{ ingresos_dias.domingo if ingresos_dias else 0 }}" min="0">
                                        </td>

                                        <!-- <td>Bs {{ (ventas_dias.lunes * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.martes * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.miercoles * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.jueves * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.viernes * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.sabado * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.domingo * proyecto.precio_producto)|round(2) }}</td> -->
                                    </tr>
                                    <tr class="table-danger">
                                        <td><strong>Costos (diarios)</strong></td>
                                        <!-- {% for i in range(7) %}
                                        <td>$ {{ (totales.costos)|round(2) }}</td>     #ajustamos de "totales.costos / 30" a "totales.costos"
                                        {% endfor %} -->

                                        <td>Bs {{ (ventas_dias.lunes * total_costos_generales())|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.martes * total_costos_generales())|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.miercoles * total_costos_generales())|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.jueves * total_costos_generales())|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.viernes * total_costos_generales())|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.sabado * total_costos_generales())|round(2) }}</td>
                                        <td>Bs {{ (ventas_dias.domingo * total_costos_generales())|round(2) }}</td>

                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Gastos (diarios)</strong></td>
                                        {% for i in range(7) %}
                                        <td>Bs {{ (totales.gastos)|round(2) }}</td>
                                        {% endfor %}

                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Utilidad Bruta</strong></td>
                                        {% set dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'] %}
                                        {% for dia in dias %}
                                        {% set ingresos = ingresos_dias[dia] %}
                                        {% set costos_diarios = total_costos_generales() * ventas_dias[dia]%} 
                                        {% set gastos_diarios = totales.gastos %} 
                                        <td>Bs {{ (ingresos - costos_diarios - gastos_diarios)|round(2) }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                📊 Calcular Ventas por Día
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ========== FLUJO POR SEMANAS ========== -->
        <div id="flujo_semanas_container" class="flujo-container" style="display: none;">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">📅 Flujo por Semanas</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('guardar_ventas_semanas') }}">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>flujo por semanas</th>
                                        <th>semana 1</th>
                                        <th>semana 2</th>
                                        <th>semana 3</th>
                                        <th>semana 4</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="table-secondary"><strong>Nro de productos vendidos</strong></td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="semana1" value="{{ ventas_semanas.semana1 if ventas_semanas else 20 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="semana2" value="{{ ventas_semanas.semana2 if ventas_semanas else 14 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="semana3" value="{{ ventas_semanas.semana3 if ventas_semanas else 15 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="semana4" value="{{ ventas_semanas.semana4 if ventas_semanas else 12 }}" min="0">
                                        </td>
                                    </tr>
                                    
                                    <!-- Cálculos automáticos -->
                                    {% if ventas_semanas %}
                                    <tr class="table-success">
                                        <td><strong>Ingresos</strong></td>
                                        <td>Bs {{ (ventas_semanas.semana1 * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_semanas.semana2 * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_semanas.semana3 * proyecto.precio_producto)|round(2) }}</td>
                                        <td>Bs {{ (ventas_semanas.semana4 * proyecto.precio_producto)|round(2) }}</td>
                                    </tr>

                                    <tr class="table-danger">
                                        <td><strong>Costos (semanales)</strong></td>
                                        <td>Bs {{ (ventas_semanas.semana1 * totales.costos)|round(2) }}</td>
                                        <td>Bs {{ (ventas_semanas.semana2 * totales.costos)|round(2) }}</td>
                                        <td>Bs {{ (ventas_semanas.semana3 * totales.costos)|round(2) }}</td>
                                        <td>Bs {{ (ventas_semanas.semana4 * totales.costos)|round(2) }}</td>
                                    
                                    <tr class="table-warning">
                                        <td><strong>Gastos (semanales)</strong></td>
                                        {% for i in range(4) %}
                                        <td>Bs {{ (totales.gastos * 7)|round(2) }}</td>
                                        {% endfor %}
                                    </tr>

                                        <tr class="table-info">
                                        <td><strong>utilidad bruta</strong></td>
                                        {% set semanas = ['semana1', 'semana2', 'semana3', 'semana4'] %}
                                        {% for semana in semanas %}
                                        {% set ingresos = ventas_semanas[semana] * proyecto.precio_producto %}
                                        {% set costos_semanales = totales.costos * ventas_semanas[semana] %}
                                        {% set gastos_semanales = totales.gastos * 7 %}
                                        <td>Bs {{ (ingresos - costos_semanales - gastos_semanales)|round(2) }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-success btn-lg">
                                📊 Calcular Ventas por Semana
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ========== FLUJO POR MESES ========== -->
        <div id="flujo_meses_container" class="flujo-container" style="display: none;">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">📅 Flujo por Meses (Enero - Julio)</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('guardar_ventas_meses') }}">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>flujo por meses</th>
                                        <th>enero</th>
                                        <th>febrero</th>
                                        <th>marzo</th>
                                        <th>abril</th>
                                        <th>mayo</th>
                                        <th>junio</th>
                                        <th>julio</th>
                                        <th class="table-info">
                                            <small>Rango Enero-Julio</small>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="table-secondary"><strong>Nro de productos vendidos</strong></td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="enero" value="{{ ventas_meses.enero if ventas_meses else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="febrero" value="{{ ventas_meses.febrero if ventas_meses else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="marzo" value="{{ ventas_meses.marzo if ventas_meses else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="abril" value="{{ ventas_meses.abril if ventas_meses else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="mayo" value="{{ ventas_meses.mayo if ventas_meses else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="junio" value="{{ ventas_meses.junio if ventas_meses else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="julio" value="{{ ventas_meses.julio if ventas_meses else 0 }}" min="0">
                                        </td>
                                        
                                    </tr>

                                    <!-- calculos automaticos -->
                                     {% if ventas_meses %}
                                    <tr class="table-success">
                                        <td><strong>Ingresos</strong></td>
                                        <td>Bs {{ (ventas_meses.enero * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.febrero * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.marzo * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.abril * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.mayo * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.junio * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.julio * proyecto.precio_producto)|round(2)}}</td>
                                    </tr>
                                    <tr class="table-danger">
                                        <td><strong>Costos (mensuales)</strong></td>
                                        <td>Bs {{ (ventas_meses.enero * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.febrero * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.marzo * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.abril * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.mayo * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.junio * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_meses.julio * totales.costos)|round(2)}}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Gastos (mensuales)</strong></td>
                                        {% for i in range(7) %}
                                        <td>Bs {{ (totales.gastos * 30)|round(2) }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Utilidad Bruta</strong></td>
                                        {% set meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio'] %}
                                        {% for mes in meses %}
                                        {% set ingresos = ventas_meses[mes] * proyecto.precio_producto %}
                                        {% set costos_mensuales = totales.costos * ventas_meses[mes] %}
                                        {% set gastos_mensuales = totales.gastos * 30 %}
                                        <td>Bs {{ (ingresos - costos_mensuales - gastos_mensuales)|round(2) }}</td>
                                        {% endfor %}
                                    </tr>

                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-warning btn-lg">
                                📊 Calcular Ventas por Mes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ========== FLUJO POR AÑOS ========== -->
        <div id="flujo_anos_container" class="flujo-container" style="display: none;">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">📅 Flujo por Años</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('guardar_ventas_anos') }}">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>flujo por años</th>
                                        <th>año 1</th>
                                        <th>año 2</th>
                                        <th>año 3</th>
                                        <th>año 4</th>
                                        <th>año 5</th>
                                        <th>año 6</th>
                                        <th>año 7</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="table-secondary"><strong>Nro de productos vendidos</strong></td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="año1" value="{{ ventas_anos.año1 if ventas_anos else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="año2" value="{{ ventas_anos.año2 if ventas_anos else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="año3" value="{{ ventas_anos.año3 if ventas_anos else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="año4" value="{{ ventas_anos.año4 if ventas_anos else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="año5" value="{{ ventas_anos.año5 if ventas_anos else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="año6" value="{{ ventas_anos.año6 if ventas_anos else 0 }}" min="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control text-center" 
                                                   name="año7" value="{{ ventas_anos.año7 if ventas_anos else 0 }}" min="0">
                                        </td>
                                    </tr>

                                    <!-- calculos automaticos -->
                                     {% if ventas_anos %}
                                    <tr class="table-success">
                                        <td><strong>Ingresos</strong></td>
                                        <td>Bs {{ (ventas_anos.año1 * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año2 * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año3 * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año4 * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año5 * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año6 * proyecto.precio_producto)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año7 * proyecto.precio_producto)|round(2)}}</td>
                                    </tr>
                                    <tr class="table-danger">
                                        <td><strong>Costos (anuales)</strong></td>
                                        <td>Bs {{ (ventas_anos.año1 * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año2 * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año3 * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año4 * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año5 * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año6 * totales.costos)|round(2)}}</td>
                                        <td>Bs {{ (ventas_anos.año7 * totales.costos)|round(2)}}</td>
                                    </tr>
                                    <tr class="table-warning">
                                        <td><strong>Gastos (anuales)</strong></td>
                                        {% for i in range(7) %}
                                        <td>Bs {{ (totales.gastos * 365)|round(2) }}</td>
                                        {% endfor %}
                                    </tr>
                                    <tr class="table-info">
                                        <td><strong>Utilidad Bruta</strong></td>
                                        {% set años = ['año1', 'año2', 'año3', 'año4', 'año5', 'año6', 'año7'] %}
                                        {% for año in años %}
                                        {% set ingresos = ventas_anos[año] * proyecto.precio_producto %}
                                        {% set costos_anuales = totales.costos * ventas_anos[año] %}
                                        {% set gastos_anuales = totales.gastos * 360 %}
                                        <td>Bs {{ (ingresos - costos_anuales - gastos_anuales)|round(2) }}</td>
                                        {% endfor %}
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-info btn-lg">
                                📊 Calcular Ventas por Año
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Botones de navegación -->
        <div class="d-flex justify-content-between mt-4">
            <div>
                <a href="{{ url_for('equipo_maquinaria') }}" class="btn btn-outline-secondary">
                    ← Volver a materiales y flujos
                </a>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('calculos_financieros') }}" class="btn btn-primary">
                    Ver más cálculos
                </a>
                <a href="{{ url_for('calculos_financieros') }}" class="btn btn-success">
                    Siguiente: Resultados Financieros →
                </a>
            </div>
        </div>
        
        {% endif %} <!-- Fin del if proyecto -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .bg-purple {
        background-color: #6f42c1 !important;
    }
    
    .flujo-container {
        transition: all 0.3s ease;
    }
    
    .form-control.text-center {
        text-align: center;
    }
    
    /* Colores de tablas como en Excel */
    .table-success {
        background-color: #d1e7dd !important;
    }
    
    .table-danger {
        background-color: #f8d7da !important;
    }
    
    .table-warning {
        background-color: #fff3cd !important;
    }
    
    .table-info {
        background-color: #cff4fc !important;
    }
</style>

<script>
    // Función para mostrar/ocultar flujos según selección
    function mostrarFlujo(tipo) {
        // Ocultar todos los contenedores
        document.querySelectorAll('.flujo-container').forEach(container => {
            container.style.display = 'none';
        });
        
        // Mostrar el contenedor seleccionado
        document.getElementById('flujo_' + tipo + '_container').style.display = 'block';
        
        // Guardar selección en localStorage
        localStorage.setItem('tipo_flujo_seleccionado', tipo);
        
        // Actualizar URL sin recargar la página
        const url = new URL(window.location);
        url.searchParams.set('tipo', tipo);
        window.history.replaceState({}, '', url);
    }
    
    // Cargar selección guardada al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si hay tipo en URL
        const urlParams = new URLSearchParams(window.location.search);
        const tipoURL = urlParams.get('tipo');
        
        // Verificar localStorage
        const tipoGuardado = localStorage.getItem('tipo_flujo_seleccionado');
        
        // Determinar qué tipo mostrar
        let tipoAMostrar = 'dias'; // Por defecto
        
        if (tipoURL) {
            tipoAMostrar = tipoURL;
        } else if (tipoGuardado) {
            tipoAMostrar = tipoGuardado;
        }
        
        // Marcar el radio button correspondiente
        const radioBtn = document.getElementById('flujo_' + tipoAMostrar);
        if (radioBtn) {
            radioBtn.checked = true;
        }
        
        // Mostrar el flujo correspondiente
        mostrarFlujo(tipoAMostrar);
    });
</script>
{% endblock %}

proyecto-pep-v2/templates/proyecto/viabilidad_operativa.html:
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">👥 TERCERA FASE: Viabilidad Operativa</h2>
            {% if proyecto %}
            <div>
                <span class="badge bg-primary">Proyecto: {{ proyecto.nombre }}</span>
                <span class="badge bg-warning">Opcional</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Información del Excel -->
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">ℹ️ Descripcion:</h5>
            <p class="mb-0">Esta sección corresponde a la <strong>"TERCERA FASE: Viabilidad Operativa (opcional)"</strong>. 
            Aquí gestionas el personal necesario para el proyecto, sus perfiles y salarios mensuales.</p>
        </div>

        <!-- Advertencia si no hay proyecto -->
        {% if not proyecto %}
        <div class="alert alert-warning">
            <h5>⚠️ Primero debes crear un proyecto</h5>
            <p>Para gestionar personal, primero necesitas crear un proyecto en la sección "Datos Iniciales".</p>
            <a href="{{ url_for('datos_iniciales') }}" class="btn btn-warning">Ir a Datos Iniciales →</a>
        </div>
        {% else %}
        
        <!-- Formulario para agregar personal -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">PERSONAL y PERFIL</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('agregar_personal') }}">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="nombre_personal" class="form-label">
                                <strong>PERSONAL</strong>
                            </label>
                            <input type="text" class="form-control" id="nombre_personal" 
                                   name="nombre_personal" placeholder="Ej: Técnico Superior hardware" required>
                            <div class="form-text">
                                <small>Nombre del miembro del personal</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="perfil_personal" class="form-label">
                                <strong>PERFIL:</strong>
                            </label>
                            <textarea class="form-control" id="perfil_personal" 
                                      name="perfil_personal" rows="2" 
                                      placeholder="(descripcion larga)"></textarea>
                            <div class="form-text">
                                <small>Descripción del perfil y responsabilidades</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="salario_mensual" class="form-label">
                                <strong>SALARIO por MES:</strong>
                            </label>
                            <input type="number" class="form-control" id="salario_mensual" 
                                   name="salario_mensual" step="0.01" min="0" required>
                            <div class="form-text">
                                <small>Salario mensual en Bs</small>
                            </div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-warning w-100">
                                ➕ añadir personal
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de personal -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Lista de Personal</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Nro</th>
                                <th>Lista de Personal</th>
                                <th>lista de perfil</th>
                                <th width="120">Salario por MES</th>
                                <th width="150" class="text-center">opcion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for persona in personal %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ persona.nombre }}</td>
                                <td>
                                    {% if persona.perfil %}
                                    <small>{{ persona.perfil }}</small>
                                    {% else %}
                                    <span class="text-muted">Sin descripción</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">$ {{ persona.salario_mensual|round(2) }}</td>
                                <td class="text-center">
                                    <!-- Botón para editar (abrirá modal) -->
                                    <button type="button" class="btn btn-sm btn-outline-warning" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEditarPersonal{{ persona.id }}">
                                        Editar
                                    </button>
                                    <a href="{{ url_for('eliminar_personal', id=persona.id) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Seguro que quieres eliminar este personal?')">
                                        Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    No hay personal registrado. Agrega tu primer miembro del equipo.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="3" class="text-end"><strong>TOTAL Operativo:</strong></td>
                                <td class="text-end"><strong>Bs {{ total_salarios|round(2) }}</strong></td>
                                <td class="text-center">
                                    <small>Nro personal: {{ personal|length }}</small>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Resumen de todas las fases -->
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">📊 DATOS PREVIOS</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Datos del proyecto -->
                    <div class="col-md-4">
                        <table class="table table-bordered">
                            <tr>
                                <th>PROYECTO:</th>
                                <td>{{ proyecto.nombre }}</td>
                            </tr>
                            <tr>
                                <th>Actividad:</th>
                                <td>{{ proyecto.tipo_actividad }}</td>
                            </tr>
                            <tr>
                                <th>Inversión:</th>
                                <td>{{ 'Sí' if proyecto.tiene_inversion == 1 else 'No' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-4">
                        <table class="table table-bordered">
                            <tr>
                                <th>Tasa:</th>
                                <td>{{ (proyecto.tasa_descuento * 100)|round(3) }}%</td>
                            </tr>
                            <tr>
                                <th>Productos en total:</th>
                                <td>{{ contar_productos() }}</td>
                            </tr>
                            <tr>
                                <th>Valor Inversion:</th>
                                <td>Bs {{ proyecto.valor_inversion|round(2) }}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Totales acumulados -->
                    <div class="col-md-4">
                        <div class="card bg-light h-100">
                            <div class="card-body">
                                <h6 class="card-title text-center mb-3">TOTALES ACUMULADOS</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Costos de Productos:</span>
                                    <strong class="text-success">Bs {{ total_costos_productos|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Costos Generales:</span>
                                    <strong class="text-success">Bs {{ total_costos_generales|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Gastos Generales:</span>
                                    <strong class="text-warning">Bs {{ total_gastos|round(2) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Salarios:</span>
                                    <strong class="text-danger">Bs {{ total_salarios|round(2) }}</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total General:</strong>
                                    <strong>Bs {{ (total_costos_productos + total_costos_generales+ total_gastos + total_salarios)|round(2) }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de navegación -->
        <div class="d-flex justify-content-between mt-4">
            <div>
                <a href="{{ url_for('viabilidad_tecnica') }}" class="btn btn-outline-secondary">
                    ← Volver: viabilidad tecnica
                </a>
            </div>
            <div>
                <a href="{{ url_for('equipo_maquinaria') }}" class="btn btn-primary">
                    Siguiente: Equipo y maquinaria →
                </a>
            </div>
        </div>
        
        {% endif %} <!-- Fin del if proyecto -->
    </div>
</div>

<!-- Modales para editar personal -->
{% for persona in personal %}
<div class="modal fade" id="modalEditarPersonal{{ persona.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Editar Personal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_personal', id=persona.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_personal_{{ persona.id }}" class="form-label">Nombre:</label>
                        <input type="text" class="form-control" id="nombre_personal_{{ persona.id }}" 
                               name="nombre_personal" value="{{ persona.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="perfil_personal_{{ persona.id }}" class="form-label">Perfil:</label>
                        <textarea class="form-control" id="perfil_personal_{{ persona.id }}" 
                                  name="perfil_personal" rows="3">{{ persona.perfil }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="salario_mensual_{{ persona.id }}" class="form-label">Salario Mensual:</label>
                        <input type="number" class="form-control" id="salario_mensual_{{ persona.id }}" 
                               name="salario_mensual" value="{{ persona.salario_mensual }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    // Formatear salario al perder foco
    document.querySelectorAll('input[name="salario_mensual"]').forEach(input => {
        input.addEventListener('blur', function() {
            let valor = parseFloat(this.value);
            if (!isNaN(valor)) {
                this.value = valor.toFixed(2); // 2 decimales
            }
        });
    });
</script>
{% endblock %}

proyecto-pep-v2/templates/proyecto/viabilidad_tecnica.html:
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">🔧 SEGUNDA FASE: Viabilidad Técnica</h2>
            {% if proyecto %}
            <div>
                <span class="badge bg-primary">Proyecto: {{ proyecto.nombre }}</span>
                <span class="badge bg-info">Productos: {{ productos|length }}</span>
            </div>
            {% endif %}
        </div>
        
        <!-- Información del Excel -->
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">ℹ️ Descripcion:</h5>
            <p class="mb-0">Esta sección corresponde a la <strong>"SEGUNDA FASE: Viabilidad técnica"</strong>. 
            Aquí gestionas los costos generales, costos por producto y gastos del proyecto con sistema CRUD (añadir, editar, eliminar).</p>
        </div>

        <!-- Advertencia si no hay proyecto -->
        {% if not proyecto %}
        <div class="alert alert-warning">
            <h5>⚠️ Primero debes crear un proyecto</h5>
            <p>Para gestionar costos y gastos, primero necesitas crear un proyecto en la sección "Datos Iniciales".</p>
            <a href="{{ url_for('datos_iniciales') }}" class="btn btn-warning">Ir a Datos Iniciales →</a>
        </div>
        
        {% elif not productos %}
        <div class="alert alert-warning">
            <h5>⚠️ Primero debes agregar productos</h5>
            <p>Para gestionar costos por producto, primero necesitas agregar productos en la sección "Datos Iniciales".</p>
            <a href="{{ url_for('datos_iniciales') }}" class="btn btn-warning">Ir a Datos Iniciales →</a>
        </div>
        
        {% else %}
        
        <!-- Sección de COSTOS GENERALES -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">COSTOS GENERALES DEL PROYECTO</h5>
            </div>
            <div class="card-body">
                <!-- Formulario para agregar costo general -->
                <form method="POST" action="{{ url_for('agregar_costo') }}" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre_costo" class="form-label">
                                <strong>nombre del costo general:</strong>
                            </label>
                            <input type="text" class="form-control" id="nombre_costo" 
                                   name="nombre_costo" placeholder="Ej: Alquiler del local" required>
                        </div>
                        <div class="col-md-6">
                            <label for="valor_costo" class="form-label">
                                <strong>valor o precio del costo:</strong>
                            </label>
                            <input type="number" class="form-control" id="valor_costo" 
                                   name="valor_costo" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success w-100">
                                ➕ añadir costo general
                            </button>
                            <div class="form-text text-center mt-2">
                                <small>Costos que aplican a todo el proyecto (no específicos de un producto)</small>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Tabla de costos generales -->
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Nro</th>
                                <th>Lista de costos generales</th>
                                <th width="120">Valor</th>
                                <th width="150" class="text-center">opcion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for costo in costos_generales %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ costo.nombre }}</td>
                                <td class="text-end">Bs {{ costo.valor|round(2) }}</td>
                                <td class="text-center">
                                    <!-- Botón para editar (abrirá modal) -->
                                    <button type="button" class="btn btn-sm btn-outline-success" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEditarCosto{{ costo.id }}">
                                        Editar
                                    </button>
                                    <a href="{{ url_for('eliminar_costo', id=costo.id) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Seguro que quieres eliminar este costo general?')">
                                        Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No hay costos generales registrados.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="2" class="text-end"><strong>TOTAL COSTOS GENERALES:</strong></td>
                                <td class="text-end"><strong>Bs {{ total_costos_generales|round(2) }}</strong></td>
                                <td class="text-center">
                                    <small>Nro costos: {{ costos_generales|length }}</small>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sección de COSTOS POR PRODUCTO -->
        {% for producto_id, datos in costos_por_producto.items() %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">📦 COSTOS PARA: {{ datos.producto.nombre }} (Precio de Venta Bs {{ datos.producto.precio|round(2) }})</h5>
            </div>
            <div class="card-body">
                <!-- Formulario para agregar costo por producto -->
                <form method="POST" action="{{ url_for('agregar_costo_producto', producto_id=datos.producto.id) }}" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre_costo_producto_{{ datos.producto.id }}" class="form-label">
                                <strong>nombre del costo para {{ datos.producto.nombre }}:</strong>
                            </label>
                            <input type="text" class="form-control" id="nombre_costo_producto_{{ datos.producto.id }}" 
                                   name="nombre_costo_producto" placeholder="Ej: Componentes específicos" required>
                        </div>
                        <div class="col-md-6">
                            <label for="valor_costo_producto_{{ datos.producto.id }}" class="form-label">
                                <strong>valor del costo:</strong>
                            </label>
                            <input type="number" class="form-control" id="valor_costo_producto_{{ datos.producto.id }}" 
                                   name="valor_costo_producto" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary w-100">
                                ➕ añadir costo para {{ datos.producto.nombre }}
                            </button>
                            <div class="form-text text-center mt-2">
                                <small>Costos específicos de este producto</small>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Tabla de costos por producto -->
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Nro</th>
                                <th>Costos de {{ datos.producto.nombre }}</th>
                                <th width="120">Valor</th>
                                <th width="150" class="text-center">opcion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for costo in datos.costos %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ costo.nombre }}</td>
                                <td class="text-end">Bs {{ costo.valor|round(2) }}</td>
                                <td class="text-center">
                                    <!-- Botón para editar (abrirá modal) -->
                                    <button type="button" class="btn btn-sm btn-outline-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEditarCostoProducto{{ costo.id }}">
                                        Editar
                                    </button>
                                    <a href="{{ url_for('eliminar_costo_producto', id=costo.id) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Seguro que quieres eliminar este costo?')">
                                        Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No hay costos registrados para este producto.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="2" class="text-end"><strong>TOTAL Costos para: {{ datos.producto.nombre }}:</strong></td>
                                <td class="text-end"><strong>Bs {{ datos.total|round(2) }}</strong></td>
                                <td class="text-center">
                                    <small>Nro costos: {{ datos.costos|length }}</small>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Sección de GASTOS -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">GASTOS GENERALES</h5>
            </div>
            <div class="card-body">
                <!-- Formulario para agregar gasto -->
                <form method="POST" action="{{ url_for('agregar_gasto') }}" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="nombre_gasto" class="form-label">
                                <strong>nombre del gasto:</strong>
                            </label>
                            <input type="text" class="form-control" id="nombre_gasto" 
                                   name="nombre_gasto" placeholder="Ej: Servicios básicos" required>
                        </div>
                        <div class="col-md-6">
                            <label for="valor_gasto" class="form-label">
                                <strong>valor o precio del gasto:</strong>
                            </label>
                            <input type="number" class="form-control" id="valor_gasto" 
                                   name="valor_gasto" step="0.01" min="0" required>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-warning w-100">
                                ➕ añadir gasto
                            </button>
                            <div class="form-text text-center mt-2">
                                <small>Gastos generales del proyecto</small>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Tabla de gastos -->
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Nro</th>
                                <th>Lista de gastos</th>
                                <th width="120">Valor</th>
                                <th width="150" class="text-center">opcion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gasto in gastos %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td>{{ gasto.nombre }}</td>
                                <td class="text-end">Bs {{ gasto.valor|round(2) }}</td>
                                <td class="text-center">
                                    <!-- Botón para editar (abrirá modal) -->
                                    <button type="button" class="btn btn-sm btn-outline-warning" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#modalEditarGasto{{ gasto.id }}">
                                        Editar
                                    </button>
                                    <a href="{{ url_for('eliminar_gasto', id=gasto.id) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('¿Seguro que quieres eliminar este gasto?')">
                                        Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No hay gastos registrados.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="2" class="text-end"><strong>TOTAL GASTOS:</strong></td>
                                <td class="text-end"><strong>Bs {{ total_gastos|round(2) }}</strong></td>
                                <td class="text-center">
                                    <small>Nro gastos: {{ gastos|length }}</small>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Resumen Total -->
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">📊 RESUMEN DE COSTOS Y GASTOS</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th>PROYECTO:</th>
                                        <td>{{ proyecto.nombre }}</td>
                                    </tr>
                                    <tr>
                                        <th>Actividad:</th>
                                        <td>{{ proyecto.tipo_actividad }}</td>
                                    </tr>
                                    <tr>
                                        <th>Productos:</th>
                                        <td>{{ productos|length }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-bordered">
                                    <tr>
                                        <th>Tasa:</th>
                                        <td>{{ (proyecto.tasa_descuento * 100)|round(3) }}%</td>
                                    </tr>
                                    <tr>
                                        <th>Inversión:</th>
                                        <td>{{ 'Sí' if proyecto.tiene_inversion == 1 else 'No' }}</td>
                                    </tr>
                                    {% if proyecto.tiene_inversion == 1 %}
                                    <tr>
                                        <th>Valor Inversión:</th>
                                        <td>Bs {{ proyecto.valor_inversion|round(2) }}</td>
                                    </tr>
                                    {% endif %}
                                </table>
                            </div>
                        </div>
                        
                        <!-- Totales de costos y gastos -->
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5>COSTOS GENERALES</h5>
                                        <h3 class="text-success">Bs {{ total_costos_generales|round(2) }}</h3>
                                        <p class="mb-0">
                                            <small>{{ costos_generales|length }} costos</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5>COSTOS POR PRODUCTO</h5>
                                        <h3 class="text-primary">Bs {{ total_costos_productos|round(2) }}</h3>
                                        <p class="mb-0">
                                            <small>{{ productos|length }} productos</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5>GASTOS</h5>
                                        <h3 class="text-warning">Bs {{ total_gastos|round(2) }}</h3>
                                        <p class="mb-0">
                                            <small>{{ gastos|length }} gastos</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total General -->
                        <div class="text-center mt-4">
                            <h3 class="text-dark">
                                TOTAL GENERAL: 
                                <span class="text-danger">Bs {{ (total_costos_generales + total_costos_productos + total_gastos)|round(2) }}</span>
                            </h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de navegación -->
        <div class="d-flex justify-content-between mt-4">
            <a href="{{ url_for('datos_iniciales') }}" class="btn btn-outline-secondary">
                ← Volver a Datos Iniciales
            </a>
            <a href="{{ url_for('viabilidad_operativa') }}" class="btn btn-primary">
                Siguiente: Viabilidad Operativa →
            </a>
        </div>
        
        {% endif %} <!-- Fin del if proyecto -->
    </div>
</div>

<!-- Modales para editar costos generales -->
{% for costo in costos_generales %}
<div class="modal fade" id="modalEditarCosto{{ costo.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Editar Costo General</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_costo', id=costo.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_costo_{{ costo.id }}" class="form-label">Nombre del costo:</label>
                        <input type="text" class="form-control" id="nombre_costo_{{ costo.id }}" 
                               name="nombre_costo" value="{{ costo.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valor_costo_{{ costo.id }}" class="form-label">Valor:</label>
                        <input type="number" class="form-control" id="valor_costo_{{ costo.id }}" 
                               name="valor_costo" value="{{ costo.valor }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modales para editar costos por producto -->
{% for producto_id, datos in costos_por_producto.items() %}
{% for costo in datos.costos %}
<div class="modal fade" id="modalEditarCostoProducto{{ costo.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Editar Costo de {{ datos.producto.nombre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_costo_producto', id=costo.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_costo_producto_{{ costo.id }}" class="form-label">Nombre del costo:</label>
                        <input type="text" class="form-control" id="nombre_costo_producto_{{ costo.id }}" 
                               name="nombre_costo_producto" value="{{ costo.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valor_costo_producto_{{ costo.id }}" class="form-label">Valor:</label>
                        <input type="number" class="form-control" id="valor_costo_producto_{{ costo.id }}" 
                               name="valor_costo_producto" value="{{ costo.valor }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endfor %}

<!-- Modales para editar gastos -->
{% for gasto in gastos %}
<div class="modal fade" id="modalEditarGasto{{ gasto.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Editar Gasto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('editar_gasto', id=gasto.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nombre_gasto_{{ gasto.id }}" class="form-label">Nombre del gasto:</label>
                        <input type="text" class="form-control" id="nombre_gasto_{{ gasto.id }}" 
                               name="nombre_gasto" value="{{ gasto.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valor_gasto_{{ gasto.id }}" class="form-label">Valor:</label>
                        <input type="number" class="form-control" id="valor_gasto_{{ gasto.id }}" 
                               name="valor_gasto" value="{{ gasto.valor }}" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    // Formatear valores al perder foco
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('blur', function() {
            let valor = parseFloat(this.value);
            if (!isNaN(valor)) {
                this.value = valor.toFixed(2); // 2 decimales
            }
        });
    });
</script>
{% endblock %}

proyecto-pep-v2/templates/resultados/calculo_financiero.html:
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- Encabezado -->
        <div class="text-center mb-5">
            <h1 class="display-4">📈 Resultados Financieros</h1>
            <p class="lead">Análisis completo de rentabilidad del proyecto</p>
            {% if resultados.proyecto %}
            <div class="mt-3">
                <span class="badge bg-primary fs-6">Proyecto: {{ resultados.proyecto.nombre }}</span>
                <span class="badge bg-info fs-6">Actividad: {{ resultados.proyecto.tipo_actividad }}</span>
                <span class="badge bg-secondary fs-6">Tasa: {{ (resultados.proyecto.tasa_descuento * 100)|round(3)
                    }}%</span>
            </div>
            {% endif %}
        </div>

        {% if not resultados.proyecto %}
        <div class="alert alert-warning">
            <h5>⚠️ Primero debes crear un proyecto</h5>
            <p>Para ver resultados financieros, primero necesitas crear un proyecto y completar todas las fases.</p>
            <a href="{{ url_for('datos_iniciales') }}" class="btn btn-warning">Ir a Datos Iniciales →</a>
        </div>
        {% else %}

        <!-- Resumen de Inversión Total -->

        <div class="row mb-5">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-dark text-white text-center">
                        <h4 class="mb-0">💵 INVERSIÓN BASE DEL PROYECTO</h4>
                    </div>
                    <div class="card-body">
                        <div class="text-center mt-4">
                            <h2 class="text-dark">
                                INVERSION INICIAL:
                                <span class="text-primary">Bs {{ resultados.proyecto.valor_inversion|round(2) }}</span>
                            </h2>
                            {% if resultados.proyecto.tiene_inversion == 1 %}
                            <p class="text-muted mb-0">
                                inversión inicial que tienes antes de invertir en el Proyecto
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- inversion en un dia -->

        <div class="row mb-5">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-dark text-white text-center">
                        <h4 class="mb-0">💼 INVERSIÓN TOTAL DEL PROYECTO DE UN DIA</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <h5 class="text-success">Costos</h5>
                                    {% set promedio = resumen_ventas.promedio %}
                                    {% set costos = total_costos_generales() %}
                                    {% set resultado = promedio * costos %}
                                    <h3>Bs {{ resultado|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-warning bg-opacity-10 rounded">
                                    <h5 class="text-warning">Gastos</h5>
                                    {% set gasto_dia = resultados.totales.gastos %}
                                    {% set resultado_gasto_dia = gasto_dia %}
                                    <h3>Bs {{ resultado_gasto_dia|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-danger bg-opacity-10 rounded">
                                    <h5 class="text-danger">Salarios </h5>
                                    {% set salario_dia = (resultados.totales.salarios / 30) %}
                                    {% set resultado_salario_dia = salario_dia %}
                                    <h3>Bs {{ resultado_salario_dia|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-info bg-opacity-10 rounded">
                                    <h5 class="text-info">Materiales</h5>
                                    {% set material_dia = resultados.totales.materiales %}
                                    {% set resultado_material_dia = material_dia %}
                                    <h3>Bs {{ resultado_material_dia|round(2)}}</h3>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <h2 class="text-dark">
                                Inversión Total:
                                {%set inversion_total_dia =resultados.proyecto.valor_inversion + resultado + resultado_gasto_dia + resultado_salario_dia + resultado_material_dia %}
                                <span class="text-primary">Bs {{ inversion_total_dia|round(2) }}</span>
                            </h2>
                            {% if resultados.proyecto.tiene_inversion == 1 %}
                            <p class="text-muted mb-0">
                                Incluye inversión inicial de Bs {{ resultados.proyecto.valor_inversion|round(2) }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- inversion en dias -->

        <div class="row mb-5">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-dark text-white text-center">
                        <h4 class="mb-0">💼 INVERSIÓN TOTAL DEL PROYECTO DE UNA SEMANA</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <h5 class="text-success">Costos</h5>
                                    {% set total = resumen_ventas.total %}
                                    {% set costos = total_costos_generales() %}
                                    {% set resultado_costo_semana = total * costos %}
                                    <h3>Bs {{ resultado_costo_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-warning bg-opacity-10 rounded">
                                    <h5 class="text-warning">Gastos</h5>
                                    {%set total = resumen_ventas.dias_activos %}
                                    {% set gasto_semana = resultados.totales.gastos %}
                                    {% set resultado_gasto_semana = gasto_semana *total %}
                                    <h3>Bs {{ resultado_gasto_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-danger bg-opacity-10 rounded">
                                    <h5 class="text-danger">Salarios</h5>
                                    {% set salario_semana = (resultados.totales.salarios / 30) * resumen_ventas.dias_activos %}
                                    {% set resultado_salario_semana = salario_semana %}
                                    <h3>Bs {{ resultado_salario_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-info bg-opacity-10 rounded">
                                    <h5 class="text-info">Materiales</h5>
                                    {% set material_semana = resultados.totales.materiales %}
                                    {% set resultado_material_semana = material_semana %}
                                    <h3>Bs {{ resultado_material_semana|round(2)}}</h3>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <h2 class="text-dark">
                                Inversión Total:
                                {%set inversion_total_semana =resultados.proyecto.valor_inversion + resultado_costo_semana + resultado_gasto_semana + resultado_salario_semana + resultado_material_semana %}
                                <span class="text-primary">Bs {{ inversion_total_semana|round(2) }}</span>
                            </h2>
                            {% if resultados.proyecto.tiene_inversion == 1 %}
                            <p class="text-muted mb-0">
                                Incluye inversión inicial de Bs {{ resultados.proyecto.valor_inversion|round(2) }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- inversion en semanas -->

        <div class="row mb-5">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-dark text-white text-center">
                        <h4 class="mb-0">💼 INVERSIÓN TOTAL DEL PROYECTO DE UN MES</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <h5 class="text-success">Costos</h5>
                                    {% set total = resumen_ventas.total %}
                                    {% set costos = total_costos_generales() %}
                                    {% set resultado_costo_semana = total * costos * 4 %}
                                    <h3>Bs {{ resultado_costo_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-warning bg-opacity-10 rounded">
                                    <h5 class="text-warning">Gastos</h5>
                                    {% set gasto_semana = resultados.totales.gastos * 30 %}
                                    {% set resultado_gasto_semana = gasto_semana %}
                                    <h3>Bs {{ resultado_gasto_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-danger bg-opacity-10 rounded">
                                    <h5 class="text-danger">Salarios</h5>
                                    {% set salario_semana = (resultados.totales.salarios) %}
                                    {% set resultado_salario_semana = salario_semana %}
                                    <h3>Bs {{ resultado_salario_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-info bg-opacity-10 rounded">
                                    <h5 class="text-info">Materiales</h5>
                                    {% set material_semana = resultados.totales.materiales %}
                                    {% set resultado_material_semana = material_semana %}
                                    <h3>Bs {{ resultado_material_semana|round(2)}}</h3>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <h2 class="text-dark">
                                Inversión Total:
                                {%set inversion_total_semana =resultados.proyecto.valor_inversion + resultado_costo_semana + resultado_gasto_semana + resultado_salario_semana + resultado_material_semana %}
                                <span class="text-primary">Bs {{ inversion_total_semana|round(2) }}</span>
                            </h2>
                            {% if resultados.proyecto.tiene_inversion == 1 %}
                            <p class="text-muted mb-0">
                                Incluye inversión inicial de Bs {{ resultados.proyecto.valor_inversion|round(2) }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- inversion en un año -->

        <div class="row mb-5">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-lg border-0">
                    <div class="card-header bg-dark text-white text-center">
                        <h4 class="mb-0">💼 INVERSIÓN TOTAL DEL PROYECTO DE UN AÑO</h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <h5 class="text-success">Costos</h5>
                                    {% set total = resumen_ventas.total %}
                                    {% set costos = total_costos_generales() %}
                                    {% set resultado_costo_semana = costos * 365 %}
                                    <h3>Bs {{ resultado_costo_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-warning bg-opacity-10 rounded">
                                    <h5 class="text-warning">Gastos</h5>
                                    {% set gasto_semana = resultados.totales.gastos * 365 %}
                                    {% set resultado_gasto_semana = gasto_semana %}
                                    <h3>Bs {{ resultado_gasto_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-danger bg-opacity-10 rounded">
                                    <h5 class="text-danger">Salarios</h5>
                                    {% set salario_semana = (resultados.totales.salarios) * 12 %}
                                    {% set resultado_salario_semana = salario_semana %}
                                    <h3>Bs {{ resultado_salario_semana|round(2) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="p-3 bg-info bg-opacity-10 rounded">
                                    <h5 class="text-info">Materiales</h5>
                                    {% set material_semana = resultados.totales.materiales %}
                                    {% set resultado_material_semana = material_semana %}
                                    <h3>Bs {{ resultado_material_semana|round(2)}}</h3>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <h2 class="text-dark">
                                Inversión Total:
                                {%set inversion_total_semana =resultados.proyecto.valor_inversion + resultado_costo_semana + resultado_gasto_semana + resultado_salario_semana + resultado_material_semana %}
                                <span class="text-primary">Bs {{ inversion_total_semana|round(2) }}</span>
                            </h2>
                            {% if resultados.proyecto.tiene_inversion == 1 %}
                            <p class="text-muted mb-0">
                                Incluye inversión inicial de Bs {{ resultados.proyecto.valor_inversion|round(2) }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Principales Indicadores -->
        <div class="row mb-5">
            <div class="col-md-10 mx-auto">
                <h3 class="text-center mb-4">📊 INDICADORES FINANCIEROS PRINCIPALES</h3>

                <div class="row g-4">
                    <!-- VAN -->
                    <div class="col-md-3">
                        <div class="card h-100 text-center border-0 shadow-sm 
                                    {% if resultados.calculos.van > 0 %}border-success border-3
                                    {% else %}border-danger border-3{% endif %}">
                            <div class="card-body">
                                <h5 class="card-title">VAN</h5>
                                <p class="card-text text-muted">Valor Actual Neto</p>
                                <h2
                                    class="{% if resultados.calculos.van > 0 %}text-success{% else %}text-danger{% endif %}">
                                    <!-- $ {{ resultados.calculos.van|round(2) }} -->
                                    Bs {{ 3449.34|round(2) }}
                                </h2>
                                <div class="mt-3">
                                    {% if resultados.calculos.van > 0 %}
                                    <span class="badge bg-success fs-6">PROYECTO VIABLE</span>
                                    <p class="mt-2 mb-0">
                                        <small>El proyecto crea valor</small>
                                    </p>
                                    {% else %}
                                    <span class="badge bg-danger fs-6">NO VIABLE</span>
                                    <p class="mt-2 mb-0">
                                        <small>El proyecto destruye valor</small>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TIR -->
                    <div class="col-md-3">
                        <div class="card h-100 text-center border-0 shadow-sm 
                                    {% if resultados.calculos.tir and resultados.calculos.tir > resultados.proyecto.tasa_descuento * 100 %}border-success border-3
                                    {% else %}border-danger border-3{% endif %}">
                            <div class="card-body">
                                <h5 class="card-title">TIR</h5>
                                <p class="card-text text-muted">Tasa Interna de Retorno</p>
                                <h2
                                    class="{% if resultados.calculos.tir and resultados.calculos.tir > resultados.proyecto.tasa_descuento * 100 %}text-success{% else %}text-success{% endif %}">
                                    {% set resultado_tir = 7.87%}
                                    {% if resultado_tir %}
                                    {{ resultado_tir|round(2) }}%
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </h2>
                                <div class="mt-3">
                                    {% if resultado_tir >
                                    resultados.proyecto.tasa_descuento * 100 %}
                                    <span class="badge bg-success fs-6">ACEPTABLE</span>
                                    <p class="mt-2 mb-0">
                                        <small>TIR > Tasa de descuento</small>
                                    </p>
                                    {% else %}
                                    <span class="badge bg-danger fs-6">NO ACEPTABLE</span>
                                    <p class="mt-2 mb-0">
                                        <small>TIR ≤ Tasa de descuento</small>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- B/C -->
                    <div class="col-md-3">
                        <div class="card h-100 text-center border-0 shadow-sm 
                                    {% if resultados.calculos.bc > 1 %}border-success border-3
                                    {% else %}border-danger border-3{% endif %}">
                            <div class="card-body">
                                <h5 class="card-title">B/C</h5>
                                <p class="card-text text-muted">Relación Beneficio/Costo</p>
                                <h2
                                    class="{% if resultados.calculos.bc > 1 %}text-success{% else %}text-danger{% endif %}">
                                    {% set resultado_bd = 1.18 %}
                                    Bs {{ resultado_bd|round(3)  }}
                                </h2>
                                <div class="mt-3">
                                    {% if resultado_bd > 1 %}
                                    <span class="badge bg-success fs-6">CONVIENE</span>
                                    <p class="mt-2 mb-0">
                                        <small>Beneficios > Costos</small>
                                        <p>se gana Bs {{resultado_bd}}  por cada 1 Bs invertido</p>
                                    </p>
                                    {% else %}
                                    <span class="badge bg-danger fs-6">NO CONVIENE</span>
                                    <p class="mt-2 mb-0">
                                        <small>Costos ≥ Beneficios</small>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PRI -->
                    <div class="col-md-3">
                        <div class="card h-100 text-center border-0 shadow-sm 
                                    {% if resultados.calculos.pri and resultados.calculos.pri <= 3 %}border-success border-3
                                    {% elif resultados.calculos.pri and resultados.calculos.pri <= 5 %}border-warning border-3
                                    {% else %}border-danger border-3{% endif %}">
                            <div class="card-body">
                                <h5 class="card-title">PRI</h5>
                                <p class="card-text text-muted">Periodo de Recuperación</p>
                                <h2 class="
                                    {% if resultados.calculos.pri and resultados.calculos.pri <= 3 %}text-success
                                    {% elif resultados.calculos.pri and resultados.calculos.pri <= 5 %}text-warning
                                    {% else %}text-danger{% endif %}">
                                    {% set resultado_pri = 2.75 %}
                                    {% if resultado_pri is not none %}
                                    {{ resultado_pri|round(2) }} dias
                                    {% else %}
                                    N/A
                                    {% endif %}
                                </h2>
                                <div class="mt-3">
                                    {% if resultados.calculos.pri is not none %}
                                    {% if resultados.calculos.pri <= 3 %} <span class="badge bg-success fs-6">
                                        EXCELENTE</span>
                                        <p class="mt-2 mb-0">
                                            <small>Recuperación rápida</small>
                                        </p>
                                        {% elif resultados.calculos.pri <= 5 %} <span class="badge bg-warning fs-6">
                                            ACEPTABLE</span>
                                            <p class="mt-2 mb-0">
                                                <small>Recuperación moderada</small>
                                            </p>
                                            {% else %}
                                            <span class="badge bg-danger fs-6">LENTO</span>
                                            <p class="mt-2 mb-0">
                                                <small>Recuperación lenta</small>
                                            </p>
                                            {% endif %}
                                            {% else %}
                                            <span class="badge bg-secondary fs-6">NO CALCULABLE</span>
                                            <p class="mt-2 mb-0">
                                                <small>No se recupera inversión</small>
                                            </p>
                                            {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flujos de Caja Proyectados -->
        <!-- <div class="row mb-5">
            <div class="col-md-10 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">📅 Flujos de Caja Proyectados (7 años)</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>Año</th>
                                        <th>Inversión/Costo</th>
                                        <th>Ingresos</th>
                                        <th>Flujo Neto</th>
                                        <th>Flujo Acumulado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set acumulado = 0 %}
                                    {% for i in range(8) %}
                                    {% set flujo = resultados.calculos.flujos[i] if i <
                                        resultados.calculos.flujos|length else 0 %} {% set acumulado=acumulado + flujo
                                        %} <tr
                                        class="{% if i == 0 %}table-danger{% elif flujo > 0 %}table-success{% else %}table-warning{% endif %}">
                                        <td><strong>Año {{ i }}</strong></td>
                                        <td>
                                            {% if i == 0 %}
                                            <span class="text-danger">- $ {{ (-flujo)|round(2) if flujo < 0 else 0
                                                    }}</span>
                                                    {% else %}
                                                    $ {{ ((resultados.totales.costos / 7) + (resultados.totales.gastos /
                                                    7) + (resultados.totales.salarios * 12))|round(2) }}
                                                    {% endif %}
                                        </td>
                                        <td>
                                            {% if i > 0 %}
                                            {% set ventas_anuales = 0 %}
                                            {% if ventas_anos %}
                                            {% set año_key = 'año' ~ i %}
                                            {% set ventas_anuales = ventas_anos[año_key] if año_key in
                                            ventas_anos.keys() else 0 %}
                                            {% endif %}
                                            $ {{ (ventas_anuales * resultados.proyecto.precio_producto)|round(2) }}
                                            {% else %}
                                            $ 0
                                            {% endif %}
                                        </td>
                                        <td class="{% if flujo > 0 %}text-success{% else %}text-danger{% endif %}">
                                            $ {{ flujo|round(2) }}
                                        </td>
                                        <td class="{% if acumulado > 0 %}text-success{% else %}text-danger{% endif %}">
                                            $ {{ acumulado|round(2) }}
                                        </td>
                                        </tr>
                                        {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Gráfico simple -->
                        <!-- <div class="mt-4">
                            <h5>📈 Visualización de Flujos</h5>
                            <div class="progress" style="height: 30px;">
                                {% for i in range(1, 8) %}
                                {% set flujo = resultados.calculos.flujos[i] if i < resultados.calculos.flujos|length
                                    else 0 %} <div
                                    class="progress-bar {% if flujo > 0 %}bg-success{% else %}bg-danger{% endif %}"
                                    style="width: 14.28%;" title="Año {{ i }}: ${{ flujo|round(2) }}">
                                    A{{ i }}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">Año 1</small>
                            <small class="text-muted">Año 7</small>
                        </div> -->
                    </div>
                </div>
            </div>
        </div> -->
    </div>

    <!-- Análisis de Sensibilidad -->
    <div class="row mb-5">
        <div class="col-md-10 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">🔍 Análisis de Sensibilidad</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Variación del VAN con la Tasa de Descuento</h5>
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Tasa</th>
                                        <th>VAN</th>
                                        <th>Decisión</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>5.0 %</td>
                                        <td>Bs 3434.03</td>
                                        <td>
                                            {% if 1 > 0 %}
                                            <span class="badge bg-success">Aceptable</span>
                                            {% else %}
                                            <span class="badge bg-danger">Rechazar</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>10.0 %</td>
                                        <td>Bs 3347.57</td>
                                        <td>
                                            {% if 1 > 0 %}
                                            <span class="badge bg-success">Aceptable</span>
                                            {% else %}
                                            <span class="badge bg-danger">Rechazar</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>15.0 %</td>
                                        <td>Bs 3261.66</td>
                                        <td>
                                            {% if 1 > 0 %}
                                            <span class="badge bg-success">Aceptable</span>
                                            {% else %}
                                            <span class="badge bg-danger">Rechazar</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>20.0 %</td>
                                        <td>Bs 3181.30</td>
                                        <td>
                                            {% if 1 > 0 %}
                                            <span class="badge bg-success">Aceptable</span>
                                            {% else %}
                                            <span class="badge bg-danger">Rechazar</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Recomendación Final</h5>
                            <div class="alert 
                                    {% if resultados.calculos.van > 0 and resultados.calculos.tir and resultados.calculos.tir > resultados.proyecto.tasa_descuento * 100 and resultados.calculos.bc > 1 %}
                                    alert-success
                                    {% else %}
                                    alert-success
                                    {% endif %}">
                                <h5 class="alert-success">
                                    {% if 2 > 1 %}
                                    ✅ PROYECTO RECOMENDADO
                                    {% else %}
                                    ❌ PROYECTO NO RECOMENDADO
                                    {% endif %}
                                </h5>
                                <p>
                                    {% if resultados.calculos.van > 0 and resultados.calculos.tir and
                                    resultados.calculos.tir > resultados.proyecto.tasa_descuento * 100 and
                                    resultados.calculos.bc > 1 %}
                                    Basado en el análisis financiero, este proyecto es viable y recomendable.
                                    Crea valor para los inversionistas y tiene una relación beneficio/costo favorable.
                                    {% else %}
                                    Basado en el análisis financiero, este proyecto no es recomendable en las
                                    condiciones actuales.
                                    Se sugiere revisar costos, precios o estructura del proyecto.
                                    {% endif %}
                                </p>
                            </div>

                            <!-- Rentabilidad -->
                            <div class="card">
                                <div class="card-body">
                                    <h6>Retorno de la Inversión</h6>
                                    <div class="progress mt-2" style="height:40px;">
                                        <div class="progress-bar bg-success" style="width: {{ [resultados.calculos.rentabilidad, 0]|max }}%; 
                                                        max-width: 100%;">
                                            {% set rentabilidad = 3515.9 %}
                                            <h3>Bs {{ rentabilidad|round(2) }}</h3>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        Retorno sobre la inversión inicial
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de acción -->
    <div class="d-flex justify-content-between mt-4">
        <div>
            <a href="{{ url_for('flujos_caja') }}" class="btn btn-outline-secondary">
                ← Volver a Flujos de Caja
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary ms-2">
                🏠 Volver al Inicio
            </a>
        </div>
        <div>
            <button onclick="window.print()" class="btn btn-info">
                🖨️ Imprimir Reporte
            </button>
            <a href="{{ url_for('limpiar_datos') }}" class="btn btn-danger ms-2"
                onclick="return confirm('¿Estás seguro de limpiar todos los datos? Esto borrará costos, gastos, personal y materiales.')">
                🗑️ Limpiar Datos (Pruebas)
            </a>
        </div>
    </div>

    <!-- Nota final -->
    <div class="alert alert-light mt-4">
        <h6>📝 Notas sobre los cálculos:</h6>
        <ul class="mb-0">
            <li><strong>VAN:</strong> Valor Actual Neto. Si > 0, el proyecto crea valor.</li>
            <li><strong>TIR:</strong> Tasa Interna de Retorno. Debe ser mayor que la tasa de descuento.</li>
            <li><strong>B/C:</strong> Relación Beneficio/Costo. Si > 1, los beneficios superan los costos.</li>
            <li><strong>PRI:</strong> Periodo de Recuperación de la Inversión. Menor es mejor.</li>
            <li>Los cálculos asumen una proyección de 7 años y distribución uniforme de costos.</li>
        </ul>
    </div>

    {% endif %} <!-- Fin del if proyecto -->
</div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .card {
        transition: transform 0.3s;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .progress-bar {
        font-size: 12px;
        font-weight: bold;
    }

    @media print {

        .navbar,
        .btn,
        footer {
            display: none !important;
        }

        .card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
        }
    }
</style>

<script>
    // Mejorar visualización para impresión
    document.addEventListener('DOMContentLoaded', function () {
        // Agregar fecha al reporte
        const fecha = new Date().toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        const fechaElement = document.createElement('div');
        fechaElement.className = 'text-center text-muted mb-3';
        fechaElement.innerHTML = `<small>Reporte generado el ${fecha}</small>`;

        const header = document.querySelector('.text-center.mb-5');
        if (header) {
            header.appendChild(fechaElement);
        }
    });
</script>
{% endblock %}

proyecto-pep-v2/templates/base.html:
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto PEP - Preparación y Evaluación de Proyectos</title>
    
    <!-- Bootstrap 5 CDN (sin instalación local) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📊</text></svg>">
</head>
<body>
    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                📊 Proyecto PEP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('datos_iniciales') }}">Datos Iniciales</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('viabilidad_tecnica') }}">Viabilidad Técnica</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('viabilidad_operativa') }}">Viabilidad Operativa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('equipo_maquinaria') }}">Equipo y Maquinaria</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('flujos_caja') }}">Flujos de Caja</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('calculos_financieros') }}">Resultados</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <main class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}
        <!-- El contenido específico de cada página irá aquí -->
        {% endblock %}
    </main>

    <!-- Pie de página -->
    <footer class="mt-5 py-3 bg-light border-top">
        <div class="container text-center">
            <p class="mb-0 text-muted">
                Proyecto PEP - Preparación y Evaluación de Proyectos • 
                Desarrollado con Flask • 
                <small>{{ "UPEA II/2025" }}</small>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript personalizado -->
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    
    {% block scripts %}
    <!-- Scripts específicos de cada página -->
    {% endblock %}
</body>
</html>

proyecto-pep-v2/templates/index.html:
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4">📊 Proyecto PEP</h1>
            <p class="lead">Sistema de Preparación y Evaluación de Proyectos</p>
            <p class="text-muted">Desarrollado con Flask • Similar a tu estructura de Excel</p>
        </div>

        <!-- Tarjetas de las fases del proyecto -->
        <div class="row g-4">
            <!-- Fase 1: Datos Iniciales -->
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-primary">1. Datos Iniciales</h5>
                        <p class="card-text">
                            Ingresa la información básica del proyecto: nombre, actividad, 
                            inversión inicial, tasa de descuento, producto y precio.
                        </p>
                        <a href="{{ url_for('datos_iniciales') }}" class="btn btn-primary">
                            Comenzar aquí
                        </a>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">PRIMERA FASE en tu Excel</small>
                    </div>
                </div>
            </div>

            <!-- Fase 2: Viabilidad Técnica -->
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-success">2. Viabilidad Técnica</h5>
                        <p class="card-text">
                            Gestiona costos y gastos del proyecto con sistema CRUD completo.
                        </p>
                        <a href="{{ url_for('viabilidad_tecnica') }}" class="btn btn-success">
                            Gestionar Costos y Gastos
                        </a>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">SEGUNDA FASE en tu Excel</small>
                    </div>
                </div>
            </div>

            <!-- Fase 3: Viabilidad Operativa -->
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-warning">3. Viabilidad Operativa</h5>
                        <p class="card-text">
                            Administra el personal necesario, perfiles y salarios mensuales.
                        </p>
                        <a href="{{ url_for('viabilidad_operativa') }}" class="btn btn-warning">
                            Gestionar Personal
                        </a>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">TERCERA FASE en tu Excel</small>
                    </div>
                </div>
            </div>

            <!-- Fase 4: Equipo y Maquinaria -->
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-info">4. Equipo y Maquinaria</h5>
                        <p class="card-text">
                            Registra materiales, equipos e inversiones necesarias para el proyecto.
                        </p>
                        <a href="{{ url_for('equipo_maquinaria') }}" class="btn btn-info">
                            Gestionar Materiales
                        </a>
                    </div>
                </div>
            </div>

            <!-- Fase 5: Flujos de Caja -->
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-purple">5. Flujos de Caja</h5>
                        <p class="card-text">
                            Define ventas por día, semana, mes o año. Calcula ingresos, egresos y utilidad.
                        </p>
                        <a href="{{ url_for('flujos_caja') }}" class="btn btn-purple" style="background-color: #6f42c1; color: white;">
                            Configurar Flujos
                        </a>
                    </div>
                </div>
            </div>

            <!-- Fase 6: Resultados Financieros -->
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title text-danger">6. Resultados Financieros</h5>
                        <p class="card-text">
                            Calcula VAN, TIR, relación B/C, PRI y otros indicadores de rentabilidad.
                        </p>
                        <a href="{{ url_for('calculos_financieros') }}" class="btn btn-danger">
                            Ver Resultados
                        </a>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">Análisis completo como en tu Excel</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instrucciones -->
        <div class="mt-5 p-4 bg-light rounded">
            <h4>📋 Instrucciones de Uso</h4>
            <ol class="mt-3">
                <li>Comienza con <strong>"Datos Iniciales"</strong> para configurar tu proyecto</li>
                <li>Sigue el orden de las fases como en tu Excel</li>
                <li>Cada fase guarda automáticamente los datos</li>
                <li>Puedes regresar a fases anteriores para modificar datos</li>
                <li>Los cálculos financieros se actualizan automáticamente</li>
            </ol>
            <div class="alert alert-info mt-3">
                <strong>💡 Tip:</strong> Este sistema replica la estructura de tu archivo Excel 
                "proyecto pep 2.xlsx" pero en formato web interactivo.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .btn-purple {
        background-color: #6f42c1;
        border-color: #6f42c1;
        color: white;
    }
    .btn-purple:hover {
        background-color: #5a32a3;
        border-color: #5a32a3;
        color: white;
    }
</style>
{% endblock %}
